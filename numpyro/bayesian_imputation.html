

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Bayesian Imputation &mdash; NumPyro Tutorials 0.4.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ordinal Regression" href="ordinal_regression.html" />
    <link rel="prev" title="Time Series Forecasting" href="time_series_forecasting.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> NumPyro Tutorials
          

          
            
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bayesian_regression.html">Bayesian Regression Using NumPyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="time_series_forecasting.html">Time Series Forecasting</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bayesian Imputation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Dataset">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Prepare-data">Prepare data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Modelling">Modelling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Sampling">Sampling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Prediction">Prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ordinal_regression.html">Ordinal Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_hierarchical_linear_regression.html">Bayesian Hierarchical Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_hierarchical_linear_regression.html#References">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="discrete_imputation.html">Bayesian imputation for missing values in discrete covariates with HMC</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Code Examples</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NumPyro Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Bayesian Imputation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/bayesian_imputation.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Bayesian-Imputation">
<h1>Bayesian Imputation<a class="headerlink" href="#Bayesian-Imputation" title="Permalink to this headline">¶</a></h1>
<p>Real-world datasets often contain many missing values. In those situations, we have to either remove those missing data (also known as “complete case”) or replace them by some values. Though using complete case is pretty straightforward, it is only applicable when the number of missing entries is so small that throwing away those entries would not affect much the power of the analysis we are conducting on the data. The second strategy, also known as
<a class="reference external" href="https://en.wikipedia.org/wiki/Imputation_%28statistics%29">imputation</a>, is more applicable and will be our focus in this tutorial.</p>
<p>Probably the most popular way to perform imputation is to fill a missing value with the mean, median, or mode of its corresponding feature. In that case, we implicitly assume that the feature containing missing values has no correlation with the remaining features of our dataset. This is a pretty strong assumption and might not be true in general. In addition, it does not encode any uncertainty that we might put on those values. Below, we will construct a <em>Bayesian</em> setting to resolve those
issues. In particular, given a model on the dataset, we will</p>
<ul class="simple">
<li><p>create a generative model for the feature with missing value</p></li>
<li><p>and consider missing values as unobserved latent variables.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># first, we need some imports</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">set_matplotlib_formats</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">ops</span><span class="p">,</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">jax.scipy.special</span> <span class="kn">import</span> <span class="n">expit</span>

<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">from</span> <span class="nn">numpyro</span> <span class="kn">import</span> <span class="n">distributions</span> <span class="k">as</span> <span class="n">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.distributions</span> <span class="kn">import</span> <span class="n">constraints</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span><span class="p">,</span> <span class="n">Predictive</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;NUMPYRO_SPHINXBUILD&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;0.4.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Dataset">
<h2>Dataset<a class="headerlink" href="#Dataset" title="Permalink to this headline">¶</a></h2>
<p>The data is taken from the competition <a class="reference external" href="https://www.kaggle.com/c/titanic">Titanic: Machine Learning from Disaster</a> hosted on <a class="reference external" href="https://www.kaggle.com/">kaggle</a>. It contains information of passengers in the <a class="reference external" href="https://en.wikipedia.org/wiki/Sinking_of_the_RMS_Titanic">Titanic accident</a> such as name, age, gender,… And our target is to predict if a person is more likely to survive.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/agconti/kaggle-titanic/master/data/train.csv&quot;</span>
<span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 891 entries, 0 to 890
Data columns (total 12 columns):
 #   Column       Non-Null Count  Dtype
---  ------       --------------  -----
 0   PassengerId  891 non-null    int64
 1   Survived     891 non-null    int64
 2   Pclass       891 non-null    int64
 3   Name         891 non-null    object
 4   Sex          891 non-null    object
 5   Age          714 non-null    float64
 6   SibSp        891 non-null    int64
 7   Parch        891 non-null    int64
 8   Ticket       891 non-null    object
 9   Fare         891 non-null    float64
 10  Cabin        204 non-null    object
 11  Embarked     889 non-null    object
dtypes: float64(2), int64(5), object(5)
memory usage: 83.7+ KB
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PassengerId</th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Look at the data info, we know that there are missing data at <code class="docutils literal notranslate"><span class="pre">Age</span></code>, <code class="docutils literal notranslate"><span class="pre">Cabin</span></code>, and <code class="docutils literal notranslate"><span class="pre">Embarked</span></code> columns. Although <code class="docutils literal notranslate"><span class="pre">Cabin</span></code> is an important feature (because the position of a cabin in the ship can affect the chance of people in that cabin to survive), we will skip it in this tutorial for simplicity. In the dataset, there are many categorical columns and two numerical columns <code class="docutils literal notranslate"><span class="pre">Age</span></code> and <code class="docutils literal notranslate"><span class="pre">Fare</span></code>. Let’s first look at the distribution of those categorical columns:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Survived&quot;</span><span class="p">,</span> <span class="s2">&quot;Pclass&quot;</span><span class="p">,</span> <span class="s2">&quot;Sex&quot;</span><span class="p">,</span> <span class="s2">&quot;SibSp&quot;</span><span class="p">,</span> <span class="s2">&quot;Parch&quot;</span><span class="p">,</span> <span class="s2">&quot;Embarked&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0    549
1    342
Name: Survived, dtype: int64

3    491
1    216
2    184
Name: Pclass, dtype: int64

male      577
female    314
Name: Sex, dtype: int64

0    608
1    209
2     28
4     18
3     16
8      7
5      5
Name: SibSp, dtype: int64

0    678
1    118
2     80
5      5
3      5
4      4
6      1
Name: Parch, dtype: int64

S    644
C    168
Q     77
Name: Embarked, dtype: int64

</pre></div></div>
</div>
</div>
<div class="section" id="Prepare-data">
<h2>Prepare data<a class="headerlink" href="#Prepare-data" title="Permalink to this headline">¶</a></h2>
<p>First, we will merge rare groups in <code class="docutils literal notranslate"><span class="pre">SibSp</span></code> and <code class="docutils literal notranslate"><span class="pre">Parch</span></code> columns together. In addition, we’ll fill 2 missing entries in <code class="docutils literal notranslate"><span class="pre">Embarked</span></code> by the mode <code class="docutils literal notranslate"><span class="pre">S</span></code>. Note that we can make a generative model for those missing entries in <code class="docutils literal notranslate"><span class="pre">Embarked</span></code> but let’s skip doing so for simplicity.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_df</span><span class="o">.</span><span class="n">SibSp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">Parch</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">Embarked</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Looking closer at the data, we can observe that each name contains a title. We know that age is correlated with the title of the name: e.g. those with Mrs. would be older than those with <code class="docutils literal notranslate"><span class="pre">Miss.</span></code> (on average) so it might be good to create that feature. The distribution of titles is:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_df</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mr.          517
Miss.        182
Mrs.         125
Master.       40
Dr.            7
Rev.           6
Mlle.          2
Major.         2
Col.           2
Ms.            1
Don.           1
the            1
Sir.           1
Lady.          1
Capt.          1
Jonkheer.      1
Mme.           1
Name: Name, dtype: int64
</pre></div></div>
</div>
<p>We will make a new column <code class="docutils literal notranslate"><span class="pre">Title</span></code>, where rare titles are merged into one group <code class="docutils literal notranslate"><span class="pre">Misc.</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">train_df</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Mr.&quot;</span><span class="p">,</span> <span class="s2">&quot;Miss.&quot;</span><span class="p">,</span> <span class="s2">&quot;Mrs.&quot;</span><span class="p">,</span> <span class="s2">&quot;Master.&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;Misc.&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now, it is ready to turn the dataframe, which includes categorical values, into numpy arrays. We also perform standardization (a good practice for regression models) for <code class="docutils literal notranslate"><span class="pre">Age</span></code> column.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">title_cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">(</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Mr.&quot;</span><span class="p">,</span> <span class="s2">&quot;Miss.&quot;</span><span class="p">,</span> <span class="s2">&quot;Mrs.&quot;</span><span class="p">,</span> <span class="s2">&quot;Master.&quot;</span><span class="p">,</span> <span class="s2">&quot;Misc.&quot;</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">embarked_cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">age_mean</span><span class="p">,</span> <span class="n">age_std</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_df</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">age</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">age_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">age_std</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">pclass</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">Pclass</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">Title</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">title_cat</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">sex</span><span class="o">=</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">Sex</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">sibsp</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">SibSp</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">parch</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">Parch</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">embarked</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">Embarked</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">embarked_cat</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">Survived</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># compute the age mean for each title</span>
<span class="n">age_notnan</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">][</span><span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">])]</span>
<span class="n">title_notnan</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">])]</span>
<span class="n">age_mean_by_title</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">age_notnan</span><span class="p">[</span><span class="n">title_notnan</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="Modelling">
<h3>Modelling<a class="headerlink" href="#Modelling" title="Permalink to this headline">¶</a></h3>
<p>First, we want to note that in NumPyro, the following models</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model1a</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model1b</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x_obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">10</span><span class="p">]),</span> <span class="n">obs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>are equivalent in the sense that both of them have</p>
<ul class="simple">
<li><p>the same latent sites <code class="docutils literal notranslate"><span class="pre">x</span></code> drawn from <code class="docutils literal notranslate"><span class="pre">dist.Normal(0,</span> <span class="pre">1)</span></code> prior,</p></li>
<li><p>and the same log densities <code class="docutils literal notranslate"><span class="pre">dist.Normal(0,</span> <span class="pre">1).log_prob(x)</span></code>.</p></li>
</ul>
<p>Now, assume that we observed the last 6 values of <code class="docutils literal notranslate"><span class="pre">x</span></code> (non-observed entries take value <code class="docutils literal notranslate"><span class="pre">NaN</span></code>), the typical model will be</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model2a</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x_impute</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x_impute&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">x_obs</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x_obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">6</span><span class="p">]),</span> <span class="n">obs</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">x_imputed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x_impute</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">])</span>
</pre></div>
</div>
<p>or with the usage of <code class="docutils literal notranslate"><span class="pre">mask</span></code>,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model2b</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x_impute</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x_impute&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">x_imputed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x_impute</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:]])</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">10</span><span class="p">]),</span> <span class="n">obs</span><span class="o">=</span><span class="n">x_imputed</span><span class="p">)</span>
</pre></div>
</div>
<p>Both approaches to model the partial observed data <code class="docutils literal notranslate"><span class="pre">x</span></code> are equivalent. For the model below, we will use the latter method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">pclass</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">sex</span><span class="p">,</span> <span class="n">sibsp</span><span class="p">,</span> <span class="n">parch</span><span class="p">,</span> <span class="n">embarked</span><span class="p">,</span> <span class="n">survived</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bayesian_impute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">b_pclass</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_Pclass&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">b_title</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_Title&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">5</span><span class="p">]))</span>
    <span class="n">b_sex</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_Sex&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">b_sibsp</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_SibSp&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">b_parch</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_Parch&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">b_embarked</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_Embarked&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">3</span><span class="p">]))</span>

    <span class="c1"># impute age by Title</span>
    <span class="n">isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
    <span class="n">age_nanidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">isnan</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bayesian_impute</span><span class="p">:</span>
        <span class="n">age_mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;age_mu&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">5</span><span class="p">]))</span>
        <span class="n">age_mu</span> <span class="o">=</span> <span class="n">age_mu</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
        <span class="n">age_sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;age_sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">5</span><span class="p">]))</span>
        <span class="n">age_sigma</span> <span class="o">=</span> <span class="n">age_sigma</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
        <span class="n">age_impute</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="s2">&quot;age_impute&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">age_mu</span><span class="p">[</span><span class="n">age_nanidx</span><span class="p">],</span> <span class="n">age_sigma</span><span class="p">[</span><span class="n">age_nanidx</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">index_update</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">age_nanidx</span><span class="p">,</span> <span class="n">age_impute</span><span class="p">)</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">age_mu</span><span class="p">,</span> <span class="n">age_sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">age</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fill missing data by the mean of ages for each title</span>
        <span class="n">age_impute</span> <span class="o">=</span> <span class="n">age_mean_by_title</span><span class="p">[</span><span class="n">title</span><span class="p">][</span><span class="n">age_nanidx</span><span class="p">]</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">index_update</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">age_nanidx</span><span class="p">,</span> <span class="n">age_impute</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_Age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b_age</span> <span class="o">*</span> <span class="n">age</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span> <span class="o">+</span> <span class="n">b_title</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_pclass</span><span class="p">[</span><span class="n">pclass</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_sex</span><span class="p">[</span><span class="n">sex</span><span class="p">]</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span> <span class="o">+</span> <span class="n">b_sibsp</span><span class="p">[</span><span class="n">sibsp</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_parch</span><span class="p">[</span><span class="n">parch</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_embarked</span><span class="p">[</span><span class="n">embarked</span><span class="p">]</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;survived&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">survived</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that in the model, the prior for <code class="docutils literal notranslate"><span class="pre">age</span></code> is <code class="docutils literal notranslate"><span class="pre">dist.Normal(age_mu,</span> <span class="pre">age_sigma)</span></code>, where the values of <code class="docutils literal notranslate"><span class="pre">age_mu</span></code> and <code class="docutils literal notranslate"><span class="pre">age_sigma</span></code> depend on <code class="docutils literal notranslate"><span class="pre">title</span></code>. Because there are missing values in <code class="docutils literal notranslate"><span class="pre">age</span></code>, we will encode those missing values in the latent parameter <code class="docutils literal notranslate"><span class="pre">age_impute</span></code>. Then we can replace <code class="docutils literal notranslate"><span class="pre">NaN</span></code> entries in <code class="docutils literal notranslate"><span class="pre">age</span></code> with the vector <code class="docutils literal notranslate"><span class="pre">age_impute</span></code>.</p>
</div>
</div>
<div class="section" id="Sampling">
<h2>Sampling<a class="headerlink" href="#Sampling" title="Permalink to this headline">¶</a></h2>
<p>We will use MCMC with NUTS kernel to sample both regression coefficients and imputed values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">survived</span><span class="o">=</span><span class="n">survived</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sample: 100%|██████████| 2000/2000 [00:18&lt;00:00, 110.91it/s, 63 steps of size 6.48e-02. acc. prob=0.94]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.0%     95.0%     n_eff     r_hat
              a      0.18      0.80      0.20     -1.14      1.50   1078.98      1.00
  age_impute[0]      0.23      0.82      0.27     -1.09      1.54   2412.70      1.00
  age_impute[1]     -0.09      0.83     -0.10     -1.34      1.39   1956.25      1.00
  age_impute[2]      0.36      0.80      0.33     -1.01      1.60   1558.35      1.00
  age_impute[3]      0.23      0.90      0.24     -1.23      1.70   2134.81      1.00
  age_impute[4]     -0.65      0.89     -0.61     -2.06      0.82   2027.61      1.00
  age_impute[5]      0.23      0.87      0.23     -1.26      1.50   1777.25      1.00
  age_impute[6]      0.45      0.78      0.45     -0.78      1.66   1428.74      1.00
  age_impute[7]     -0.66      0.91     -0.64     -2.01      0.91   2021.78      1.00
  age_impute[8]     -0.09      0.87     -0.08     -1.41      1.42   1630.14      1.00
  age_impute[9]      0.22      0.89      0.24     -1.42      1.56   1404.25      1.00
 age_impute[10]      0.20      0.87      0.20     -1.16      1.66   2489.31      1.00
 age_impute[11]      0.17      0.85      0.17     -1.28      1.51   2063.14      1.00
 age_impute[12]     -0.66      0.89     -0.62     -2.18      0.72   1632.65      1.00
 age_impute[13]      0.19      0.91      0.17     -1.34      1.64   2394.35      1.00
 age_impute[14]     -0.02      0.85     -0.01     -1.38      1.33   1809.29      1.00
 age_impute[15]      0.37      0.84      0.40     -1.04      1.66   1443.69      1.00
 age_impute[16]     -1.73      0.25     -1.73     -2.11     -1.30   2062.38      1.00
 age_impute[17]      0.22      0.86      0.22     -1.23      1.55   1565.91      1.00
 age_impute[18]      0.23      0.90      0.23     -1.28      1.72   1483.35      1.00
 age_impute[19]     -0.68      0.86     -0.66     -2.13      0.67   2069.45      1.00
 age_impute[20]      0.21      0.89      0.27     -1.39      1.59   1675.83      1.00
 age_impute[21]      0.19      0.89      0.22     -1.28      1.56   1984.23      1.00
 age_impute[22]      0.19      0.92      0.20     -1.37      1.57   1608.50      1.00
 age_impute[23]     -0.14      0.86     -0.13     -1.59      1.26   1890.99      1.00
 age_impute[24]     -0.67      0.88     -0.66     -2.14      0.74   1530.94      1.00
 age_impute[25]      0.17      0.89      0.19     -1.34      1.55   1767.90      1.00
 age_impute[26]      0.19      0.84      0.22     -1.11      1.56   1617.58      1.00
 age_impute[27]     -0.70      0.89     -0.68     -2.02      0.89   1761.35      1.00
 age_impute[28]      0.60      0.76      0.62     -0.72      1.75   1645.46      1.00
 age_impute[29]      0.24      0.85      0.24     -1.13      1.56   2126.36      1.00
 age_impute[30]      0.22      0.84      0.23     -1.03      1.69   2796.85      1.00
 age_impute[31]     -1.72      0.27     -1.72     -2.15     -1.28   2433.69      1.00
 age_impute[32]      0.43      0.86      0.43     -0.93      1.81   1458.56      1.00
 age_impute[33]      0.32      0.87      0.33     -1.08      1.70   1583.13      1.00
 age_impute[34]     -1.72      0.28     -1.72     -2.19     -1.28   2429.56      1.00
 age_impute[35]     -0.43      0.86     -0.42     -1.88      0.90   1451.65      1.00
 age_impute[36]      0.30      0.87      0.29     -1.09      1.72   2084.66      1.00
 age_impute[37]      0.30      0.83      0.33     -0.98      1.74   1924.58      1.00
 age_impute[38]      0.35      0.79      0.33     -0.82      1.73   1980.63      1.00
 age_impute[39]      0.19      0.93      0.19     -1.33      1.75   1463.15      1.00
 age_impute[40]     -0.65      0.90     -0.67     -2.04      0.85   1548.78      1.00
 age_impute[41]      0.20      0.86      0.21     -1.19      1.56   1889.65      1.00
 age_impute[42]      0.22      0.88      0.22     -1.39      1.54   1785.76      1.00
 age_impute[43]      0.21      0.82      0.23     -1.35      1.36   1663.29      1.00
 age_impute[44]     -0.40      0.92     -0.40     -1.96      1.15   1745.40      1.00
 age_impute[45]     -0.34      0.86     -0.33     -1.75      1.05   1380.72      1.00
 age_impute[46]     -0.30      0.90     -0.30     -1.87      1.10   1237.61      1.00
 age_impute[47]     -0.73      0.91     -0.73     -2.13      0.78   1467.82      1.00
 age_impute[48]      0.22      0.89      0.22     -1.15      1.84   2169.66      1.00
 age_impute[49]      0.43      0.77      0.43     -0.79      1.65   1839.23      1.00
 age_impute[50]      0.23      0.86      0.24     -1.30      1.49   1579.39      1.00
 age_impute[51]     -0.29      0.88     -0.35     -1.58      1.23   2247.95      1.00
 age_impute[52]      0.36      0.82      0.38     -1.13      1.57   1606.92      1.00
 age_impute[53]     -0.67      0.94     -0.65     -2.08      0.94   1587.69      1.00
 age_impute[54]      0.25      0.90      0.25     -1.07      1.77   2455.98      1.00
 age_impute[55]      0.33      0.88      0.33     -0.94      1.88   1593.76      1.00
 age_impute[56]      0.39      0.78      0.39     -0.81      1.65   1101.71      1.00
 age_impute[57]     -0.01      0.82     -0.03     -1.40      1.25   1532.71      1.00
 age_impute[58]     -0.69      0.90     -0.68     -2.09      0.77   1614.68      1.00
 age_impute[59]     -0.12      0.88     -0.13     -1.52      1.33   1384.61      1.00
 age_impute[60]     -0.62      0.89     -0.61     -2.08      0.77   2116.31      1.00
 age_impute[61]      0.22      0.83      0.24     -1.11      1.58   1581.98      1.00
 age_impute[62]     -0.59      0.93     -0.60     -2.17      0.88   1528.18      1.00
 age_impute[63]      0.20      0.87      0.20     -1.35      1.48   1677.96      1.00
 age_impute[64]     -0.69      0.89     -0.67     -2.22      0.70   1877.18      1.00
 age_impute[65]      0.41      0.75      0.42     -0.80      1.67   1501.98      1.00
 age_impute[66]      0.24      0.96      0.25     -1.25      1.86   2558.45      1.00
 age_impute[67]      0.32      0.73      0.34     -0.82      1.55   1678.01      1.00
 age_impute[68]      0.34      0.88      0.34     -1.05      1.83   1712.65      1.00
 age_impute[69]      0.24      0.92      0.24     -1.15      1.88   1170.47      1.00
 age_impute[70]     -0.65      0.89     -0.64     -2.13      0.76   2018.98      1.00
 age_impute[71]     -0.67      0.86     -0.69     -2.12      0.64   1625.09      1.00
 age_impute[72]      0.18      0.84      0.17     -1.14      1.53   1929.52      1.00
 age_impute[73]      0.38      0.77      0.37     -0.92      1.63   1696.03      1.00
 age_impute[74]     -0.67      0.90     -0.66     -2.14      0.81   1683.08      1.00
 age_impute[75]      0.44      0.84      0.40     -0.84      1.88   1215.51      1.00
 age_impute[76]      0.20      0.86      0.22     -1.24      1.61   1899.12      1.00
 age_impute[77]      0.18      0.86      0.16     -1.38      1.44   1809.40      1.00
 age_impute[78]     -0.42      0.87     -0.44     -1.79      1.05   2265.80      1.00
 age_impute[79]      0.20      0.84      0.20     -1.27      1.50   2009.37      1.00
 age_impute[80]      0.25      0.84      0.23     -1.15      1.64   1561.96      1.00
 age_impute[81]      0.26      0.88      0.29     -1.20      1.68   2251.52      1.00
 age_impute[82]      0.62      0.83      0.62     -0.70      1.98   1502.80      1.00
 age_impute[83]      0.21      0.86      0.20     -1.07      1.63   2044.48      1.00
 age_impute[84]      0.20      0.86      0.18     -1.30      1.54   1497.56      1.00
 age_impute[85]      0.25      0.88      0.24     -1.23      1.72   2379.66      1.00
 age_impute[86]      0.31      0.75      0.32     -1.07      1.43   1543.45      1.00
 age_impute[87]     -0.13      0.90     -0.10     -1.61      1.41   2132.30      1.00
 age_impute[88]      0.21      0.90      0.25     -1.40      1.53   1824.99      1.00
 age_impute[89]      0.23      0.93      0.23     -1.29      1.70   2859.52      1.00
 age_impute[90]      0.40      0.82      0.39     -1.00      1.73   1416.46      1.00
 age_impute[91]      0.24      0.92      0.24     -1.17      1.84   1843.64      1.00
 age_impute[92]      0.20      0.83      0.19     -1.18      1.47   1970.14      1.00
 age_impute[93]      0.24      0.89      0.26     -1.24      1.66   1831.49      1.00
 age_impute[94]      0.21      0.90      0.17     -1.24      1.69   1975.06      1.00
 age_impute[95]      0.21      0.88      0.22     -1.22      1.67   1904.83      1.00
 age_impute[96]      0.34      0.90      0.33     -1.05      1.81   2090.87      1.00
 age_impute[97]      0.27      0.88      0.24     -1.26      1.61   1768.14      1.00
 age_impute[98]     -0.40      0.92     -0.40     -1.83      1.12   1787.86      1.00
 age_impute[99]      0.16      0.91      0.14     -1.22      1.70   1518.86      1.00
age_impute[100]      0.24      0.86      0.22     -1.21      1.61   1856.56      1.00
age_impute[101]      0.20      0.88      0.21     -1.14      1.76   1967.24      1.00
age_impute[102]     -0.30      0.89     -0.28     -1.76      1.12   1795.47      1.00
age_impute[103]      0.01      0.86      0.01     -1.37      1.38   1416.70      1.00
age_impute[104]      0.25      0.92      0.26     -1.13      1.87   1643.05      1.00
age_impute[105]      0.25      0.85      0.29     -1.24      1.55   1831.86      1.00
age_impute[106]      0.25      0.87      0.24     -1.17      1.72   2185.41      1.00
age_impute[107]      0.21      0.87      0.21     -1.07      1.70   1945.87      1.00
age_impute[108]      0.34      0.86      0.35     -1.03      1.78   1666.87      1.00
age_impute[109]      0.27      0.88      0.22     -0.95      1.93   1470.86      1.00
age_impute[110]      0.32      0.76      0.35     -0.96      1.41   1737.45      1.00
age_impute[111]      0.22      0.86      0.22     -1.25      1.59   2439.65      1.00
age_impute[112]     -0.03      0.86     -0.03     -1.41      1.44   1737.27      1.00
age_impute[113]      0.22      0.87      0.23     -1.32      1.56   1211.30      1.00
age_impute[114]      0.38      0.79      0.36     -0.90      1.65   1416.21      1.00
age_impute[115]      0.20      0.88      0.19     -1.12      1.78   1437.63      1.00
age_impute[116]      0.25      0.86      0.20     -1.26      1.53   1336.80      1.00
age_impute[117]     -0.35      0.91     -0.36     -1.91      1.10   1737.09      1.00
age_impute[118]      0.23      0.94      0.23     -1.18      1.95   2347.76      1.00
age_impute[119]     -0.63      0.93     -0.66     -2.09      0.94   1681.58      1.00
age_impute[120]      0.60      0.80      0.59     -0.54      2.06   1437.89      1.00
age_impute[121]      0.21      0.85      0.23     -1.06      1.69   2152.47      1.00
age_impute[122]      0.22      0.82      0.20     -1.07      1.65   2296.29      1.00
age_impute[123]     -0.38      0.94     -0.39     -2.01      1.03   1557.61      1.00
age_impute[124]     -0.61      0.92     -0.63     -2.13      0.86   1450.41      1.00
age_impute[125]      0.24      0.93      0.23     -1.16      1.74   2397.23      1.00
age_impute[126]      0.21      0.84      0.21     -1.06      1.72   2248.42      1.00
age_impute[127]      0.36      0.87      0.36     -0.96      1.81   1663.20      1.00
age_impute[128]      0.24      0.90      0.25     -1.34      1.62   1790.40      1.00
age_impute[129]     -0.71      0.88     -0.67     -2.07      0.84   2155.52      1.00
age_impute[130]      0.19      0.85      0.17     -1.29      1.50   1766.80      1.00
age_impute[131]      0.25      0.88      0.25     -1.12      1.76   1891.41      1.00
age_impute[132]      0.32      0.88      0.32     -1.21      1.70   2209.15      1.00
age_impute[133]      0.22      0.89      0.20     -1.21      1.66   1656.09      1.00
age_impute[134]     -0.10      0.91     -0.14     -1.51      1.46   2255.33      1.00
age_impute[135]      0.22      0.85      0.23     -1.04      1.66   1534.46      1.00
age_impute[136]      0.18      0.84      0.17     -1.21      1.55   2292.26      1.00
age_impute[137]     -0.69      0.88     -0.68     -2.29      0.63   2473.01      1.00
age_impute[138]      0.19      0.93      0.18     -1.36      1.65   2256.20      1.00
age_impute[139]      0.20      0.85      0.19     -1.16      1.59   1589.73      1.00
age_impute[140]      0.40      0.79      0.41     -0.90      1.66   2200.96      1.00
age_impute[141]      0.24      0.90      0.22     -1.14      1.73   1805.79      1.00
age_impute[142]     -0.32      0.92     -0.32     -1.82      1.19   1755.92      1.00
age_impute[143]     -0.15      0.86     -0.14     -1.58      1.22   1850.64      1.00
age_impute[144]     -0.67      0.94     -0.66     -2.21      0.80   1812.97      1.00
age_impute[145]     -1.75      0.25     -1.75     -2.17     -1.36   1786.83      1.00
age_impute[146]      0.35      0.84      0.34     -1.02      1.66   2006.44      1.00
age_impute[147]      0.26      0.89      0.27     -1.27      1.61   1800.77      1.00
age_impute[148]     -0.67      0.88     -0.65     -2.13      0.68   1832.48      1.00
age_impute[149]      0.29      0.83      0.29     -1.07      1.59   2181.78      1.00
age_impute[150]      0.22      0.87      0.23     -1.20      1.63   1788.63      1.00
age_impute[151]      0.20      0.87      0.17     -1.19      1.62   1561.13      1.00
age_impute[152]      0.01      0.83     -0.01     -1.35      1.38   2966.42      1.00
age_impute[153]      0.19      0.91      0.22     -1.44      1.55   2302.81      1.00
age_impute[154]      1.06      0.96      1.07     -0.53      2.59   1612.33      1.00
age_impute[155]      0.22      0.81      0.22     -1.08      1.51   1460.31      1.00
age_impute[156]      0.27      0.94      0.25     -1.40      1.75   1409.05      1.00
age_impute[157]      0.22      0.92      0.21     -1.26      1.70   1705.55      1.00
age_impute[158]      0.22      0.87      0.22     -1.08      1.72   1561.10      1.00
age_impute[159]      0.21      0.90      0.22     -1.30      1.56   1366.89      1.00
age_impute[160]      0.18      0.84      0.14     -1.15      1.46   1437.73      1.00
age_impute[161]     -0.49      0.92     -0.52     -1.91      1.09   1357.29      1.00
age_impute[162]      0.37      0.84      0.37     -0.98      1.72   1971.90      1.00
age_impute[163]      0.31      0.84      0.28     -1.05      1.71   1541.32      1.00
age_impute[164]      0.22      0.85      0.21     -1.23      1.60   2056.93      1.00
age_impute[165]      0.23      0.88      0.22     -1.12      1.65   2037.07      1.00
age_impute[166]     -0.11      0.87     -0.11     -1.49      1.33   1851.82      1.00
age_impute[167]      0.21      0.89      0.21     -1.10      1.73   1777.15      1.00
age_impute[168]      0.20      0.83      0.21     -1.12      1.56   1793.28      1.00
age_impute[169]      0.02      0.88      0.01     -1.40      1.43   2410.48      1.00
age_impute[170]      0.16      0.88      0.16     -1.29      1.60   2230.68      1.00
age_impute[171]      0.41      0.83      0.40     -0.96      1.75   1846.52      1.00
age_impute[172]      0.24      0.89      0.22     -1.32      1.54   1852.66      1.00
age_impute[173]     -0.44      0.87     -0.45     -1.92      0.92   2089.83      1.00
age_impute[174]      0.22      0.82      0.23     -1.12      1.55   2427.19      1.00
age_impute[175]      0.22      0.96      0.26     -1.45      1.79   2380.77      1.00
age_impute[176]     -0.43      0.89     -0.41     -1.84      1.06   1803.21      1.00
      age_mu[0]      0.19      0.04      0.19      0.12      0.27   1509.52      1.00
      age_mu[1]     -0.55      0.08     -0.55     -0.67     -0.43   1224.77      1.00
      age_mu[2]      0.42      0.08      0.42      0.30      0.56   1212.38      1.00
      age_mu[3]     -1.73      0.04     -1.73     -1.79     -1.64   1274.40      1.00
      age_mu[4]      0.85      0.19      0.85      0.55      1.16   1387.85      1.00
   age_sigma[0]      0.88      0.03      0.88      0.83      0.93    646.28      1.00
   age_sigma[1]      0.90      0.05      0.90      0.82      0.98   1120.20      1.00
   age_sigma[2]      0.79      0.05      0.79      0.71      0.88   1113.02      1.00
   age_sigma[3]      0.26      0.03      0.25      0.20      0.31   1443.42      1.00
   age_sigma[4]      0.94      0.13      0.92      0.74      1.16   1106.42      1.00
          b_Age     -0.44      0.13     -0.44     -0.66     -0.24    832.14      1.00
  b_Embarked[0]     -0.30      0.53     -0.30     -1.14      0.59    525.77      1.00
  b_Embarked[1]      0.27      0.54      0.28     -0.65      1.08    572.29      1.00
  b_Embarked[2]      0.02      0.55      0.02     -1.00      0.78    524.41      1.00
     b_Parch[0]      0.44      0.57      0.46     -0.52      1.35    484.44      1.00
     b_Parch[1]      0.10      0.57      0.10     -0.76      1.11    494.90      1.00
     b_Parch[2]     -0.49      0.56     -0.48     -1.42      0.38    498.59      1.00
    b_Pclass[0]      1.16      0.56      1.17      0.32      2.15    475.02      1.00
    b_Pclass[1]      0.02      0.55      0.04     -0.87      0.94    496.89      1.00
    b_Pclass[2]     -1.23      0.56     -1.20     -2.20     -0.37    477.51      1.00
       b_Sex[0]      1.18      0.70      1.16     -0.05      2.24    691.88      1.00
       b_Sex[1]     -1.00      0.69     -1.01     -2.12      0.11    802.26      1.00
     b_SibSp[0]      0.26      0.63      0.28     -0.78      1.25    779.73      1.00
     b_SibSp[1]     -0.19      0.64     -0.18     -1.15      0.91    775.18      1.00
     b_Title[0]     -0.96      0.57     -0.96     -1.85      0.02    521.30      1.00
     b_Title[1]     -0.34      0.62     -0.33     -1.40      0.62    695.62      1.00
     b_Title[2]      0.54      0.63      0.54     -0.42      1.58    672.71      1.00
     b_Title[3]      1.46      0.64      1.46      0.32      2.39    708.52      1.00
     b_Title[4]     -0.66      0.62     -0.68     -1.61      0.49    635.26      1.00

Number of divergences: 0
</pre></div></div>
</div>
<p>To double check that the assumption “age is correlated with title” is reasonable, let’s look at the infered age by title. Recall that we performed standarization on <code class="docutils literal notranslate"><span class="pre">age</span></code>, so here we need to scale back to original domain.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">age_by_title</span> <span class="o">=</span> <span class="n">age_mean</span> <span class="o">+</span> <span class="n">age_std</span> <span class="o">*</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;age_mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">title_cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span> <span class="n">age_by_title</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;Mr.&#39;: 32.434227,
 &#39;Miss.&#39;: 21.763992,
 &#39;Mrs.&#39;: 35.852997,
 &#39;Master.&#39;: 4.6297398,
 &#39;Misc.&#39;: 42.081936}
</pre></div></div>
</div>
<p>The infered result confirms our assumption that <code class="docutils literal notranslate"><span class="pre">Age</span></code> is correlated with <code class="docutils literal notranslate"><span class="pre">Title</span></code>:</p>
<ul class="simple">
<li><p>those with <code class="docutils literal notranslate"><span class="pre">Master.</span></code> title has pretty small age (in other words, they are children in the ship) comparing to the other groups,</p></li>
<li><p>those with <code class="docutils literal notranslate"><span class="pre">Mrs.</span></code> title have larger age than those with <code class="docutils literal notranslate"><span class="pre">Miss.</span></code> title (in average).</p></li>
</ul>
<p>We can also see that the result is similar to the actual statistical mean of <code class="docutils literal notranslate"><span class="pre">Age</span></code> given <code class="docutils literal notranslate"><span class="pre">Title</span></code> in our training dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">)[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Title
Master.     4.574167
Misc.      42.384615
Miss.      21.773973
Mr.        32.368090
Mrs.       35.898148
Name: Age, dtype: float64
</pre></div></div>
</div>
<p>So far so good, we have many information about the regression coefficients together with imputed values and their uncertainties. Let’s inspect those results a bit:</p>
<ul class="simple">
<li><p>The mean value <code class="docutils literal notranslate"><span class="pre">-0.44</span></code> of <code class="docutils literal notranslate"><span class="pre">b_Age</span></code> implies that those with smaller ages have better chance to survive.</p></li>
<li><p>The mean value <code class="docutils literal notranslate"><span class="pre">(1.11,</span> <span class="pre">-1.07)</span></code> of <code class="docutils literal notranslate"><span class="pre">b_Sex</span></code> implies that female passengers have higher chance to survive than male passengers.</p></li>
</ul>
<div class="section" id="Prediction">
<h3>Prediction<a class="headerlink" href="#Prediction" title="Permalink to this headline">¶</a></h3>
<p>In NumPyro, we can use <a class="reference external" href="http://num.pyro.ai/en/stable/utilities.html#numpyro.infer.util.Predictive">Predictive</a> utility for making predictions from posterior samples. Let’s check how well the model performs on the training dataset. For simplicity, we will get a <code class="docutils literal notranslate"><span class="pre">survived</span></code> prediction for each posterior sample and perform the majority rule on the predictions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">posterior</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">survived_pred</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior</span><span class="p">)(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="o">**</span><span class="n">data</span><span class="p">)[</span><span class="s2">&quot;survived&quot;</span><span class="p">]</span>
<span class="n">survived_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">survived_pred</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy:&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">survived_pred</span> <span class="o">==</span> <span class="n">survived</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">survived</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">survived</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">survived_pred</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">confusion_matrix</span> <span class="o">/</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy: 0.8271605
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>predict</th>
      <th>0</th>
      <th>1</th>
    </tr>
    <tr>
      <th>actual</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.876138</td>
      <td>0.198830</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.156648</td>
      <td>0.748538</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>This is a pretty good result using a simple logistic regression model. Let’s see how the model performs if we don’t use Bayesian imputation here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">survived</span><span class="o">=</span><span class="n">survived</span><span class="p">,</span> <span class="n">bayesian_impute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">posterior_1</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">survived_pred_1</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior_1</span><span class="p">)(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="o">**</span><span class="n">data</span><span class="p">)[</span><span class="s2">&quot;survived&quot;</span><span class="p">]</span>
<span class="n">survived_pred_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">survived_pred_1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy:&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">survived_pred_1</span> <span class="o">==</span> <span class="n">survived</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">survived</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">survived</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">survived_pred_1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">confusion_matrix</span> <span class="o">/</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">survived</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">survived_pred_1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">confusion_matrix</span> <span class="o">/</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sample: 100%|██████████| 2000/2000 [00:11&lt;00:00, 166.79it/s, 63 steps of size 7.18e-02. acc. prob=0.93]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy: 0.82042646
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>predict</th>
      <th>0</th>
      <th>1</th>
    </tr>
    <tr>
      <th>actual</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.872495</td>
      <td>0.204678</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.163934</td>
      <td>0.736842</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We can see that Bayesian imputation does a little bit better here.</p>
<p><strong>Remark.</strong> When using <code class="docutils literal notranslate"><span class="pre">posterior</span></code> samples to perform prediction on the new data, we need to marginalize out <code class="docutils literal notranslate"><span class="pre">age_impute</span></code> because those imputing values are specific to the training data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">posterior</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;age_impute&quot;</span><span class="p">)</span>
<span class="n">survived_pred</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior</span><span class="p">)(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">**</span><span class="n">new_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="References">
<h3>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>McElreath, R. (2016). Statistical Rethinking: A Bayesian Course with Examples in R and Stan.</p></li>
<li><p>Kaggle competition: <a class="reference external" href="https://www.kaggle.com/c/titanic">Titanic: Machine Learning from Disaster</a></p></li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ordinal_regression.html" class="btn btn-neutral float-right" title="Ordinal Regression" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="time_series_forecasting.html" class="btn btn-neutral float-left" title="Time Series Forecasting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Uber Technologies, Inc

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>