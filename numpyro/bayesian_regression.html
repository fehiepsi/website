

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Bayesian Regression Using NumPyro &mdash; NumPyro Tutorials 0.4.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Time Series Forecasting" href="time_series_forecasting.html" />
    <link rel="prev" title="Welcome to NumPyro Examples and Tutorials!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> NumPyro Tutorials
          

          
            
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bayesian Regression Using NumPyro</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Tutorial-Outline:">Tutorial Outline:</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Dataset">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Regression-Model-to-Predict-Divorce-Rate">Regression Model to Predict Divorce Rate</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Model-1:-Predictor---Marriage-Rate">Model 1: Predictor - Marriage Rate</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Posterior-Distribution-over-the-Regression-Parameters">Posterior Distribution over the Regression Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Posterior-Predictive-Distribution">Posterior Predictive Distribution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Predictive-Utility-With-Effect-Handlers">Predictive Utility With Effect Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Posterior-Predictive-Density">Posterior Predictive Density</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Model-2:-Predictor---Median-Age-of-Marriage">Model 2: Predictor - Median Age of Marriage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-3:-Predictor---Marriage-Rate-and-Median-Age-of-Marriage">Model 3: Predictor - Marriage Rate and Median Age of Marriage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Divorce-Rate-Residuals-by-State">Divorce Rate Residuals by State</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Regression-Model-with-Measurement-Error">Regression Model with Measurement Error</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Effect-of-Incorporating-Measurement-Noise-on-Residuals">Effect of Incorporating Measurement Noise on Residuals</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="time_series_forecasting.html">Time Series Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_imputation.html">Bayesian Imputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="ordinal_regression.html">Ordinal Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_hierarchical_linear_regression.html">Bayesian Hierarchical Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_hierarchical_linear_regression.html#References">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="discrete_imputation.html">Bayesian imputation for missing values in discrete covariates with HMC</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Code Examples</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NumPyro Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Bayesian Regression Using NumPyro</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/bayesian_regression.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Bayesian-Regression-Using-NumPyro">
<h1>Bayesian Regression Using NumPyro<a class="headerlink" href="#Bayesian-Regression-Using-NumPyro" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we will explore how to do bayesian regression in NumPyro, using a simple example adapted from Statistical Rethinking [<a class="reference external" href="#References">1</a>]. In particular, we would like to explore the following:</p>
<ul class="simple">
<li><p>Write a simple model using the <code class="docutils literal notranslate"><span class="pre">sample</span></code> NumPyro primitive.</p></li>
<li><p>Run inference using MCMC in NumPyro, in particular, using the No U-Turn Sampler (NUTS) to get a posterior distribution over our regression parameters of interest.</p></li>
<li><p>Learn about inference utilities such as <code class="docutils literal notranslate"><span class="pre">Predictive</span></code> and <code class="docutils literal notranslate"><span class="pre">log_likelihood</span></code>.</p></li>
<li><p>Learn how we can use effect-handlers in NumPyro to generate execution traces from the model, condition on sample statements, seed models with RNG seeds, etc., and use this to implement various utilities that will be useful for MCMC. e.g. computing model log likelihood, generating empirical distribution over the posterior predictive, etc.</p></li>
</ul>
<div class="section" id="Tutorial-Outline:">
<h2>Tutorial Outline:<a class="headerlink" href="#Tutorial-Outline:" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference external" href="#Dataset">Dataset</a></p></li>
<li><p><a class="reference external" href="#Regression-Model-to-Predict-Divorce-Rate">Regression Model to Predict Divorce Rate</a></p>
<ul class="simple">
<li><p><a class="reference external" href="#Model-1:-Predictor---Marriage-Rate">Model-1: Predictor-Marriage Rate</a></p>
<ul>
<li><p><a class="reference external" href="#Posterior-Distribution-over-the-Regression-Parameters">Posterior Distribution over the Regression Parameters</a></p></li>
<li><p><a class="reference external" href="#Posterior-Predictive-Distribution">Posterior Predictive Distribution</a></p></li>
<li><p><a class="reference external" href="#Predictive-Utility-With-Effect-Handlers">Predictive Utility With Effect Handlers</a></p></li>
<li><p><a class="reference external" href="#Model-Predictive-Density">Model Predictive Density</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#Model-2:-Predictor---Median-Age-of-Marriage">Model-2: Predictor-Median Age of Marriage</a></p></li>
<li><p><a class="reference external" href="#Model-3:-Predictor---Marriage-Rate-and-Median-Age-of-Marriage">Model-3: Predictor-Marriage Rate and Median Age of Marriage</a></p></li>
<li><p><a class="reference external" href="#Divorce-Rate-Residuals-by-State">Divorce Rate Residuals by State</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#Regression-Model-with-Measurement-Error">Regression Model with Measurement Error</a></p>
<ul class="simple">
<li><p><a class="reference external" href="#Effect-of-Incorporating-Measurement-Noise-on-Residuals">Effect of Incorporating Measurement Noise on Residuals</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#References">References</a></p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">reset</span> -s -f
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">set_matplotlib_formats</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">vmap</span>
<span class="kn">from</span> <span class="nn">jax.scipy.special</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">from</span> <span class="nn">numpyro.diagnostics</span> <span class="kn">import</span> <span class="n">hpdi</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro</span> <span class="kn">import</span> <span class="n">handlers</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;NUMPYRO_SPHINXBUILD&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;0.4.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Dataset">
<h2>Dataset<a class="headerlink" href="#Dataset" title="Permalink to this headline">¶</a></h2>
<p>For this example, we will use the <code class="docutils literal notranslate"><span class="pre">WaffleDivorce</span></code> dataset from Chapter 05, Statistical Rethinking [<a class="reference external" href="#References">1</a>]. The dataset contains divorce rates in each of the 50 states in the USA, along with predictors such as population, median age of marriage, whether it is a Southern state and, curiously, number of Waffle Houses.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">DATASET_URL</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/rmcelreath/rethinking/master/data/WaffleDivorce.csv&#39;</span>
<span class="n">dset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATASET_URL</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">dset</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>Loc</th>
      <th>Population</th>
      <th>MedianAgeMarriage</th>
      <th>Marriage</th>
      <th>Marriage SE</th>
      <th>Divorce</th>
      <th>Divorce SE</th>
      <th>WaffleHouses</th>
      <th>South</th>
      <th>Slaves1860</th>
      <th>Population1860</th>
      <th>PropSlaves1860</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>AL</td>
      <td>4.78</td>
      <td>25.3</td>
      <td>20.2</td>
      <td>1.27</td>
      <td>12.7</td>
      <td>0.79</td>
      <td>128</td>
      <td>1</td>
      <td>435080</td>
      <td>964201</td>
      <td>0.450000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Alaska</td>
      <td>AK</td>
      <td>0.71</td>
      <td>25.2</td>
      <td>26.0</td>
      <td>2.93</td>
      <td>12.5</td>
      <td>2.05</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arizona</td>
      <td>AZ</td>
      <td>6.33</td>
      <td>25.8</td>
      <td>20.3</td>
      <td>0.98</td>
      <td>10.8</td>
      <td>0.74</td>
      <td>18</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Arkansas</td>
      <td>AR</td>
      <td>2.92</td>
      <td>24.3</td>
      <td>26.4</td>
      <td>1.70</td>
      <td>13.5</td>
      <td>1.22</td>
      <td>41</td>
      <td>1</td>
      <td>111115</td>
      <td>435450</td>
      <td>0.260000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>California</td>
      <td>CA</td>
      <td>37.25</td>
      <td>26.8</td>
      <td>19.1</td>
      <td>0.39</td>
      <td>8.0</td>
      <td>0.24</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>379994</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Colorado</td>
      <td>CO</td>
      <td>5.03</td>
      <td>25.7</td>
      <td>23.5</td>
      <td>1.24</td>
      <td>11.6</td>
      <td>0.94</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>34277</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Connecticut</td>
      <td>CT</td>
      <td>3.57</td>
      <td>27.6</td>
      <td>17.1</td>
      <td>1.06</td>
      <td>6.7</td>
      <td>0.77</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>460147</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Delaware</td>
      <td>DE</td>
      <td>0.90</td>
      <td>26.6</td>
      <td>23.1</td>
      <td>2.89</td>
      <td>8.9</td>
      <td>1.39</td>
      <td>3</td>
      <td>0</td>
      <td>1798</td>
      <td>112216</td>
      <td>0.016000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>District of Columbia</td>
      <td>DC</td>
      <td>0.60</td>
      <td>29.7</td>
      <td>17.7</td>
      <td>2.53</td>
      <td>6.3</td>
      <td>1.89</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>75080</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Florida</td>
      <td>FL</td>
      <td>18.80</td>
      <td>26.4</td>
      <td>17.0</td>
      <td>0.58</td>
      <td>8.5</td>
      <td>0.32</td>
      <td>133</td>
      <td>1</td>
      <td>61745</td>
      <td>140424</td>
      <td>0.440000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Georgia</td>
      <td>GA</td>
      <td>9.69</td>
      <td>25.9</td>
      <td>22.1</td>
      <td>0.81</td>
      <td>11.5</td>
      <td>0.58</td>
      <td>381</td>
      <td>1</td>
      <td>462198</td>
      <td>1057286</td>
      <td>0.440000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Hawaii</td>
      <td>HI</td>
      <td>1.36</td>
      <td>26.9</td>
      <td>24.9</td>
      <td>2.54</td>
      <td>8.3</td>
      <td>1.27</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Idaho</td>
      <td>ID</td>
      <td>1.57</td>
      <td>23.2</td>
      <td>25.8</td>
      <td>1.84</td>
      <td>7.7</td>
      <td>1.05</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Illinois</td>
      <td>IL</td>
      <td>12.83</td>
      <td>27.0</td>
      <td>17.9</td>
      <td>0.58</td>
      <td>8.0</td>
      <td>0.45</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1711951</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Indiana</td>
      <td>IN</td>
      <td>6.48</td>
      <td>25.7</td>
      <td>19.8</td>
      <td>0.81</td>
      <td>11.0</td>
      <td>0.63</td>
      <td>17</td>
      <td>0</td>
      <td>0</td>
      <td>1350428</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Iowa</td>
      <td>IA</td>
      <td>3.05</td>
      <td>25.4</td>
      <td>21.5</td>
      <td>1.46</td>
      <td>10.2</td>
      <td>0.91</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>674913</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Kansas</td>
      <td>KS</td>
      <td>2.85</td>
      <td>25.0</td>
      <td>22.1</td>
      <td>1.48</td>
      <td>10.6</td>
      <td>1.09</td>
      <td>6</td>
      <td>0</td>
      <td>2</td>
      <td>107206</td>
      <td>0.000019</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Kentucky</td>
      <td>KY</td>
      <td>4.34</td>
      <td>24.8</td>
      <td>22.2</td>
      <td>1.11</td>
      <td>12.6</td>
      <td>0.75</td>
      <td>64</td>
      <td>1</td>
      <td>225483</td>
      <td>1155684</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Louisiana</td>
      <td>LA</td>
      <td>4.53</td>
      <td>25.9</td>
      <td>20.6</td>
      <td>1.19</td>
      <td>11.0</td>
      <td>0.89</td>
      <td>66</td>
      <td>1</td>
      <td>331726</td>
      <td>708002</td>
      <td>0.470000</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Maine</td>
      <td>ME</td>
      <td>1.33</td>
      <td>26.4</td>
      <td>13.5</td>
      <td>1.40</td>
      <td>13.0</td>
      <td>1.48</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>628279</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Maryland</td>
      <td>MD</td>
      <td>5.77</td>
      <td>27.3</td>
      <td>18.3</td>
      <td>1.02</td>
      <td>8.8</td>
      <td>0.69</td>
      <td>11</td>
      <td>0</td>
      <td>87189</td>
      <td>687049</td>
      <td>0.130000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Massachusetts</td>
      <td>MA</td>
      <td>6.55</td>
      <td>28.5</td>
      <td>15.8</td>
      <td>0.70</td>
      <td>7.8</td>
      <td>0.52</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1231066</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Michigan</td>
      <td>MI</td>
      <td>9.88</td>
      <td>26.4</td>
      <td>16.5</td>
      <td>0.69</td>
      <td>9.2</td>
      <td>0.53</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>749113</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Minnesota</td>
      <td>MN</td>
      <td>5.30</td>
      <td>26.3</td>
      <td>15.3</td>
      <td>0.77</td>
      <td>7.4</td>
      <td>0.60</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>172023</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Mississippi</td>
      <td>MS</td>
      <td>2.97</td>
      <td>25.8</td>
      <td>19.3</td>
      <td>1.54</td>
      <td>11.1</td>
      <td>1.01</td>
      <td>72</td>
      <td>1</td>
      <td>436631</td>
      <td>791305</td>
      <td>0.550000</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Missouri</td>
      <td>MO</td>
      <td>5.99</td>
      <td>25.6</td>
      <td>18.6</td>
      <td>0.81</td>
      <td>9.5</td>
      <td>0.67</td>
      <td>39</td>
      <td>1</td>
      <td>114931</td>
      <td>1182012</td>
      <td>0.097000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Montana</td>
      <td>MT</td>
      <td>0.99</td>
      <td>25.7</td>
      <td>18.5</td>
      <td>2.31</td>
      <td>9.1</td>
      <td>1.71</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Nebraska</td>
      <td>NE</td>
      <td>1.83</td>
      <td>25.4</td>
      <td>19.6</td>
      <td>1.44</td>
      <td>8.8</td>
      <td>0.94</td>
      <td>0</td>
      <td>0</td>
      <td>15</td>
      <td>28841</td>
      <td>0.000520</td>
    </tr>
    <tr>
      <th>28</th>
      <td>New Hampshire</td>
      <td>NH</td>
      <td>1.32</td>
      <td>26.8</td>
      <td>16.7</td>
      <td>1.76</td>
      <td>10.1</td>
      <td>1.61</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>326073</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>29</th>
      <td>New Jersey</td>
      <td>NJ</td>
      <td>8.79</td>
      <td>27.7</td>
      <td>14.8</td>
      <td>0.59</td>
      <td>6.1</td>
      <td>0.46</td>
      <td>0</td>
      <td>0</td>
      <td>18</td>
      <td>672035</td>
      <td>0.000027</td>
    </tr>
    <tr>
      <th>30</th>
      <td>New Mexico</td>
      <td>NM</td>
      <td>2.06</td>
      <td>25.8</td>
      <td>20.4</td>
      <td>1.90</td>
      <td>10.2</td>
      <td>1.11</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>93516</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>31</th>
      <td>New York</td>
      <td>NY</td>
      <td>19.38</td>
      <td>28.4</td>
      <td>16.8</td>
      <td>0.47</td>
      <td>6.6</td>
      <td>0.31</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3880735</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>32</th>
      <td>North Carolina</td>
      <td>NC</td>
      <td>9.54</td>
      <td>25.7</td>
      <td>20.4</td>
      <td>0.98</td>
      <td>9.9</td>
      <td>0.48</td>
      <td>142</td>
      <td>1</td>
      <td>331059</td>
      <td>992622</td>
      <td>0.330000</td>
    </tr>
    <tr>
      <th>33</th>
      <td>North Dakota</td>
      <td>ND</td>
      <td>0.67</td>
      <td>25.3</td>
      <td>26.7</td>
      <td>2.93</td>
      <td>8.0</td>
      <td>1.44</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Ohio</td>
      <td>OH</td>
      <td>11.54</td>
      <td>26.3</td>
      <td>16.9</td>
      <td>0.61</td>
      <td>9.5</td>
      <td>0.45</td>
      <td>64</td>
      <td>0</td>
      <td>0</td>
      <td>2339511</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Oklahoma</td>
      <td>OK</td>
      <td>3.75</td>
      <td>24.4</td>
      <td>23.8</td>
      <td>1.29</td>
      <td>12.8</td>
      <td>1.01</td>
      <td>16</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Oregon</td>
      <td>OR</td>
      <td>3.83</td>
      <td>26.0</td>
      <td>18.9</td>
      <td>1.10</td>
      <td>10.4</td>
      <td>0.80</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>52465</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Pennsylvania</td>
      <td>PA</td>
      <td>12.70</td>
      <td>27.1</td>
      <td>15.5</td>
      <td>0.48</td>
      <td>7.7</td>
      <td>0.43</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>2906215</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Rhode Island</td>
      <td>RI</td>
      <td>1.05</td>
      <td>28.2</td>
      <td>15.0</td>
      <td>2.11</td>
      <td>9.4</td>
      <td>1.79</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>174620</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>39</th>
      <td>South Carolina</td>
      <td>SC</td>
      <td>4.63</td>
      <td>26.4</td>
      <td>18.1</td>
      <td>1.18</td>
      <td>8.1</td>
      <td>0.70</td>
      <td>144</td>
      <td>1</td>
      <td>402406</td>
      <td>703708</td>
      <td>0.570000</td>
    </tr>
    <tr>
      <th>40</th>
      <td>South Dakota</td>
      <td>SD</td>
      <td>0.81</td>
      <td>25.6</td>
      <td>20.1</td>
      <td>2.64</td>
      <td>10.9</td>
      <td>2.50</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4837</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>41</th>
      <td>Tennessee</td>
      <td>TN</td>
      <td>6.35</td>
      <td>25.2</td>
      <td>19.4</td>
      <td>0.85</td>
      <td>11.4</td>
      <td>0.75</td>
      <td>103</td>
      <td>1</td>
      <td>275719</td>
      <td>1109801</td>
      <td>0.200000</td>
    </tr>
    <tr>
      <th>42</th>
      <td>Texas</td>
      <td>TX</td>
      <td>25.15</td>
      <td>25.2</td>
      <td>21.5</td>
      <td>0.61</td>
      <td>10.0</td>
      <td>0.35</td>
      <td>99</td>
      <td>1</td>
      <td>182566</td>
      <td>604215</td>
      <td>0.300000</td>
    </tr>
    <tr>
      <th>43</th>
      <td>Utah</td>
      <td>UT</td>
      <td>2.76</td>
      <td>23.3</td>
      <td>29.6</td>
      <td>1.77</td>
      <td>10.2</td>
      <td>0.93</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>40273</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Vermont</td>
      <td>VT</td>
      <td>0.63</td>
      <td>26.9</td>
      <td>16.4</td>
      <td>2.40</td>
      <td>9.6</td>
      <td>1.87</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>315098</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>45</th>
      <td>Virginia</td>
      <td>VA</td>
      <td>8.00</td>
      <td>26.4</td>
      <td>20.5</td>
      <td>0.83</td>
      <td>8.9</td>
      <td>0.52</td>
      <td>40</td>
      <td>1</td>
      <td>490865</td>
      <td>1219630</td>
      <td>0.400000</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Washington</td>
      <td>WA</td>
      <td>6.72</td>
      <td>25.9</td>
      <td>21.4</td>
      <td>1.00</td>
      <td>10.0</td>
      <td>0.65</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>11594</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>47</th>
      <td>West Virginia</td>
      <td>WV</td>
      <td>1.85</td>
      <td>25.0</td>
      <td>22.2</td>
      <td>1.69</td>
      <td>10.9</td>
      <td>1.34</td>
      <td>4</td>
      <td>1</td>
      <td>18371</td>
      <td>376688</td>
      <td>0.049000</td>
    </tr>
    <tr>
      <th>48</th>
      <td>Wisconsin</td>
      <td>WI</td>
      <td>5.69</td>
      <td>26.3</td>
      <td>17.2</td>
      <td>0.79</td>
      <td>8.3</td>
      <td>0.57</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>775881</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>49</th>
      <td>Wyoming</td>
      <td>WY</td>
      <td>0.56</td>
      <td>24.2</td>
      <td>30.7</td>
      <td>3.92</td>
      <td>10.3</td>
      <td>1.90</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Let us plot the pair-wise relationship amongst the main variables in the dataset, using <code class="docutils literal notranslate"><span class="pre">seaborn.pairplot</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span> <span class="s1">&#39;MedianAgeMarriage&#39;</span><span class="p">,</span> <span class="s1">&#39;Marriage&#39;</span><span class="p">,</span> <span class="s1">&#39;WaffleHouses&#39;</span><span class="p">,</span> <span class="s1">&#39;South&#39;</span><span class="p">,</span> <span class="s1">&#39;Divorce&#39;</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">,</span> <span class="n">y_vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;husl&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_6_0.png" src="_images/bayesian_regression_6_0.png" />
</div>
</div>
<p>From the plots above, we can clearly observe that there is a relationship between divorce rates and marriage rates in a state (as might be expected), and also between divorce rates and median age of marriage.</p>
<p>There is also a weak relationship between number of Waffle Houses and divorce rates, which is not obvious from the plot above, but will be clearer if we regress <code class="docutils literal notranslate"><span class="pre">Divorce</span></code> against <code class="docutils literal notranslate"><span class="pre">WaffleHouse</span></code> and plot the results.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="s1">&#39;WaffleHouses&#39;</span><span class="p">,</span> <span class="s1">&#39;Divorce&#39;</span><span class="p">,</span> <span class="n">dset</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_8_0.png" src="_images/bayesian_regression_8_0.png" />
</div>
</div>
<p>This is an example of a spurious association. We do not expect the number of Waffle Houses in a state to affect the divorce rate, but it is likely correlated with other factors that have an effect on the divorce rate. We will not delve into this spurious association in this tutorial, but the interested reader is encouraged to read Chapters 5 and 6 of [<a class="reference external" href="#References">1</a>] which explores the problem of causal association in the presence of multiple predictors.</p>
<p>For simplicity, we will primarily focus on marriage rate and the median age of marriage as our predictors for divorce rate throughout the remaining tutorial.</p>
</div>
<div class="section" id="Regression-Model-to-Predict-Divorce-Rate">
<h2>Regression Model to Predict Divorce Rate<a class="headerlink" href="#Regression-Model-to-Predict-Divorce-Rate" title="Permalink to this headline">¶</a></h2>
<p>Let us now write a regressionn model in <em>NumPyro</em> to predict the divorce rate as a linear function of marriage rate and median age of marriage in each of the states.</p>
<p>First, note that our predictor variables have somewhat different scales. It is a good practice to standardize our predictors and response variables to mean <code class="docutils literal notranslate"><span class="pre">0</span></code> and standard deviation <code class="docutils literal notranslate"><span class="pre">1</span></code>, which should result in <a class="reference external" href="https://mc-stan.org/docs/2_19/stan-users-guide/standardizing-predictors-and-outputs.html">faster inference</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">standardize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">dset</span><span class="p">[</span><span class="s1">&#39;AgeScaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">standardize</span><span class="p">)</span>
<span class="n">dset</span><span class="p">[</span><span class="s1">&#39;MarriageScaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">standardize</span><span class="p">)</span>
<span class="n">dset</span><span class="p">[</span><span class="s1">&#39;DivorceScaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">standardize</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We write the NumPyro model as follows. While the code should largely be self-explanatory, take note of the following:</p>
<ul class="simple">
<li><p>In NumPyro, <em>model</em> code is any Python callable which can optionally accept additional arguments and keywords. For HMC which we will be using for this tutorial, these arguments and keywords remain static during inference, but we can reuse the same model to generate <a class="reference external" href="#Posterior-Predictive-Distribution">predictions</a> on new data.</p></li>
<li><p>In addition to regular Python statements, the model code also contains primitives like <code class="docutils literal notranslate"><span class="pre">sample</span></code>. These primitives can be interpreted with various side-effects using effect handlers. For more on effect handlers, refer to [<a class="reference external" href="#References">3</a>], [<a class="reference external" href="#References">4</a>]. For now, just remember that a <code class="docutils literal notranslate"><span class="pre">sample</span></code> statement makes this a stochastic function that samples some latent parameters from a <em>prior distribution</em>. Our goal is to infer the <em>posterior distribution</em> of these parameters
conditioned on observed data.</p></li>
<li><p>The reason why we have kept our predictors as optional keyword arguments is to be able to reuse the same model as we vary the set of predictors. Likewise, the reason why the response variable is optional is that we would like to reuse this model to sample from the posterior predictive distribution. See the <a class="reference external" href="#Posterior-Predictive-Distribution">section</a> on plotting the posterior predictive distribution, as an example.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">marriage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">marriage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bM</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;bM&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">bM</span> <span class="o">*</span> <span class="n">marriage</span>
    <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bA</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;bA&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">bA</span> <span class="o">*</span> <span class="n">age</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">M</span> <span class="o">+</span> <span class="n">A</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Model-1:-Predictor---Marriage-Rate">
<h3>Model 1: Predictor - Marriage Rate<a class="headerlink" href="#Model-1:-Predictor---Marriage-Rate" title="Permalink to this headline">¶</a></h3>
<p>We first try to model the divorce rate as depending on a single variable, marriage rate. As mentioned above, we can use the same <code class="docutils literal notranslate"><span class="pre">model</span></code> code as earlier, but only pass values for <code class="docutils literal notranslate"><span class="pre">marriage</span></code> and <code class="docutils literal notranslate"><span class="pre">divorce</span></code> keyword arguments. We will use the No U-Turn Sampler (see [<a class="reference external" href="#References">5</a>] for more details on the NUTS algorithm) to run inference on this simple model.</p>
<p>The Hamiltonian Monte Carlo (or, the NUTS) implementation in NumPyro takes in a potential energy function. This is the negative log joint density for the model. Therefore, for our model description above, we need to construct a function which given the parameter values returns the potential energy (or negative log joint density). Additionally, the verlet integrator in HMC (or, NUTS) returns sample values simulated using Hamiltonian dynamics in the unconstrained space. As such, continuous
variables with bounded support need to be transformed into unconstrained space using bijective transforms. We also need to transform these samples back to their constrained support before returning these values to the user. Thankfully, this is handled on the backend for us, within a convenience class for doing <a class="reference external" href="https://numpyro.readthedocs.io/en/latest/mcmc.html#numpyro.mcmc.MCMC">MCMC inference</a> that has the following methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run(...)</span></code>: runs warmup, adapts steps size and mass matrix, and does sampling using the sample from the warmup phase.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">print_summary()</span></code>: print diagnostic information like quantiles, effective sample size, and the Gelman-Rubin diagnostic.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_samples()</span></code>: gets samples from the posterior distribution.</p></li>
</ul>
<p>Note the following:</p>
<ul class="simple">
<li><p>JAX uses functional PRNGs. Unlike other languages / frameworks which maintain a global random state, in JAX, every call to a sampler requires an <a class="reference external" href="https://github.com/google/jax#random-numbers-are-different">explicit PRNGKey</a>. We will split our initial random seed for subsequent operations, so that we do not accidentally reuse the same seed.</p></li>
<li><p>We run inference with the <code class="docutils literal notranslate"><span class="pre">NUTS</span></code> sampler. To run vanilla HMC, we can instead use the <a class="reference external" href="https://numpyro.readthedocs.io/en/latest/mcmc.html#numpyro.mcmc.HMC">HMC</a> class.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Start from this source of randomness. We will split keys for subsequent operations.</span>
<span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>

<span class="n">num_warmup</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span>

<span class="c1"># Run NUTS.</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">samples_1</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sample: 100%|██████████| 3000/3000 [00:04&lt;00:00, 669.73it/s, 3 steps of size 7.48e-01. acc. prob=0.91]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
         a     -0.00      0.11     -0.00     -0.17      0.18   1804.63      1.00
        bM      0.35      0.13      0.35      0.13      0.56   1556.49      1.00
     sigma      0.94      0.10      0.94      0.78      1.08   1916.15      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="section" id="Posterior-Distribution-over-the-Regression-Parameters">
<h4>Posterior Distribution over the Regression Parameters<a class="headerlink" href="#Posterior-Distribution-over-the-Regression-Parameters" title="Permalink to this headline">¶</a></h4>
<p>We notice that the progress bar gives us online statistics on the acceptance probability, step size and number of steps taken per sample while running NUTS. In particular, during warmup, we adapt the step size and mass matrix to achieve a certain target acceptance probability which is 0.8, by default. We were able to successfully adapt our step size to achieve this target in the warmup phase.</p>
<p>During warmup, the aim is to adapt hyper-parameters such as step size and mass matrix (the HMC algorithm is very sensitive to these hyper-parameters), and to reach the typical set (see [<a class="reference external" href="#References">6</a>] for more details). If there are any issues in the model specification, the first signal to notice would be low acceptance probabilities or very high number of steps. We use the sample from the end of the warmup phase to seed the MCMC chain (denoted by the second <code class="docutils literal notranslate"><span class="pre">sample</span></code> progress bar) from
which we generate the desired number of samples from our target distribution.</p>
<p>At the end of inference, NumPyro prints the mean, std and 90% CI values for each of the latent parameters. Note that since we standardized our predictors and response variable, we would expect the intercept to have mean 0, as can be seen here. It also prints other convergence diagnostics on the latent parameters in the model, including <a class="reference external" href="https://numpyro.readthedocs.io/en/latest/diagnostics.html#numpyro.diagnostics.effective_sample_size">effective sample size</a> and the <a class="reference external" href="https://numpyro.readthedocs.io/en/latest/diagnostics.html#numpyro.diagnostics.gelman_rubin">gelman rubin
diagnostic</a> (<span class="math notranslate nohighlight">\(\hat{R}\)</span>). The value for these diagnostics indicates that the chain has converged to the target distribution. In our case, the “target distribution” is the posterior distribution over the latent parameters that we are interested in. Note that this is often worth verifying with multiple chains for more complicated models. In the end, <code class="docutils literal notranslate"><span class="pre">samples_1</span></code> is a collection (in our case, a
<code class="docutils literal notranslate"><span class="pre">dict</span></code> since <code class="docutils literal notranslate"><span class="pre">init_samples</span></code> was a <code class="docutils literal notranslate"><span class="pre">dict</span></code>) containing samples from the posterior distribution for each of the latent parameters in the model.</p>
<p>To look at our regression fit, let us plot the regression line using our posterior estimates for the regression parameters, along with the 90% Credibility Interval (CI). Note that the <a class="reference external" href="https://numpyro.readthedocs.io/en/latest/diagnostics.html#numpyro.diagnostics.hpdi">hpdi</a> function in NumPyro’s diagnostics module can be used to compute CI. In the functions below, note that the collected samples from the posterior are all along the leading axis.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot_regression</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_mean</span><span class="p">,</span> <span class="n">y_hpdi</span><span class="p">):</span>
    <span class="c1"># Sort values for plotting by x axis</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">marriage</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">y_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">hpdi</span> <span class="o">=</span> <span class="n">y_hpdi</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># Plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marriage</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marriage</span><span class="p">,</span> <span class="n">divorce</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">marriage</span><span class="p">,</span> <span class="n">hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="c1"># Compute empirical posterior distribution over mu</span>
<span class="n">posterior_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">samples_1</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">samples_1</span><span class="p">[</span><span class="s1">&#39;bM&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span>

<span class="n">mean_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">posterior_mu</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">hpdi_mu</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">posterior_mu</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_regression</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mean_mu</span><span class="p">,</span> <span class="n">hpdi_mu</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Marriage rate&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Divorce rate&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Regression line with 90% CI&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_17_0.png" src="_images/bayesian_regression_17_0.png" />
</div>
</div>
<p>We can see from the plot, that the CI broadens towards the tails where the data is relatively sparse, as can be expected.</p>
</div>
<div class="section" id="Posterior-Predictive-Distribution">
<h4>Posterior Predictive Distribution<a class="headerlink" href="#Posterior-Predictive-Distribution" title="Permalink to this headline">¶</a></h4>
<p>Let us now look at the posterior predictive distribution to see how our predictive distribution looks with respect to the observed divorce rates. To get samples from the posterior predictive distribution, we need to run the model by substituting the latent parameters with samples from the posterior. NumPyro provides a handy <a class="reference external" href="http://num.pyro.ai/en/latest/utilities.html#numpyro.infer.util.Predictive">Predictive</a> utility for this purpose. Note that by default we generate a single prediction for
each sample from the joint posterior distribution, but this can be controlled using the <code class="docutils literal notranslate"><span class="pre">num_samples</span></code> argument.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">Predictive</span>

<span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="n">predictive</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">samples_1</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictive</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="s1">&#39;Location&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mean Predictions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>Mean Predictions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>0.003563</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Alaska</td>
      <td>0.559501</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arizona</td>
      <td>0.007107</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Arkansas</td>
      <td>0.539909</td>
    </tr>
    <tr>
      <th>4</th>
      <td>California</td>
      <td>-0.077508</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Predictive-Utility-With-Effect-Handlers">
<h4>Predictive Utility With Effect Handlers<a class="headerlink" href="#Predictive-Utility-With-Effect-Handlers" title="Permalink to this headline">¶</a></h4>
<p>To remove the magic behind <code class="docutils literal notranslate"><span class="pre">Predictive</span></code>, let us see how we can combine <a class="reference external" href="https://numpyro.readthedocs.io/en/latest/handlers.html">effect handlers</a> with the <a class="reference external" href="https://github.com/google/jax#auto-vectorization-with-vmap">vmap</a> JAX primitive to implement our own simplified predictive utility function that can do vectorized predictions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">post_samples</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">handlers</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">),</span> <span class="n">post_samples</span><span class="p">)</span>
    <span class="n">model_trace</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_trace</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

<span class="c1"># vectorize predictions via vmap</span>
<span class="n">predict_fn</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">predict</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Note the use of the <code class="docutils literal notranslate"><span class="pre">condition</span></code>, <code class="docutils literal notranslate"><span class="pre">seed</span></code> and <code class="docutils literal notranslate"><span class="pre">trace</span></code> effect handlers in the <code class="docutils literal notranslate"><span class="pre">predict</span></code> function.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">seed</span></code> effect-handler is used to wrap a stochastic function with an initial <code class="docutils literal notranslate"><span class="pre">PRNGKey</span></code> seed. When a sample statement inside the model is called, it uses the existing seed to sample from a distribution but this effect-handler also splits the existing key to ensure that future <code class="docutils literal notranslate"><span class="pre">sample</span></code> calls in the model use the newly split key instead. This is to prevent us from having to explicitly pass in a <code class="docutils literal notranslate"><span class="pre">PRNGKey</span></code> to each <code class="docutils literal notranslate"><span class="pre">sample</span></code> statement in the model.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">condition</span></code> effect handler conditions the latent sample sites to certain values. In our case, we are conditioning on values from the posterior distribution returned by MCMC.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">trace</span></code> effect handler runs the model and records the execution trace within an <code class="docutils literal notranslate"><span class="pre">OrderedDict</span></code>. This trace object contains execution metadata that is useful for computing quantities such as the log joint density.</p></li>
</ul>
<p>It should be clear now that the <code class="docutils literal notranslate"><span class="pre">predict</span></code> function simply runs the model by substituting the latent parameters with samples from the posterior (generated by the <code class="docutils literal notranslate"><span class="pre">mcmc</span></code> function) to generate predictions. Note the use of JAX’s auto-vectorization transform called <a class="reference external" href="https://github.com/google/jax#auto-vectorization-with-vmap">vmap</a> to vectorize predictions. Note that if we didn’t use <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, we would have to use a native for loop which for each sample which is much slower. Each draw from the
posterior can be used to get predictions over all the 50 states. When we vectorize this over all the samples from the posterior using <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, we will get a <code class="docutils literal notranslate"><span class="pre">predictions_1</span></code> array of shape <code class="docutils literal notranslate"><span class="pre">(num_samples,</span> <span class="pre">50)</span></code>. We can then compute the mean and 90% CI of these samples to plot the posterior predictive distribution. We note that our mean predictions match those obtained from the <code class="docutils literal notranslate"><span class="pre">Predictive</span></code> utility class.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Using the same key as we used for Predictive - note that the results are identical.</span>

<span class="n">predictions_1</span> <span class="o">=</span> <span class="n">predict_fn</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">),</span> <span class="n">samples_1</span><span class="p">)</span>

<span class="n">mean_pred</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions_1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="s1">&#39;Location&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mean Predictions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>Mean Predictions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>0.003563</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Alaska</td>
      <td>0.559501</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arizona</td>
      <td>0.007107</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Arkansas</td>
      <td>0.539909</td>
    </tr>
    <tr>
      <th>4</th>
      <td>California</td>
      <td>-0.077508</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hpdi_pred</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">predictions_1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_regression</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mean_pred</span><span class="p">,</span> <span class="n">hpdi_pred</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Marriage rate&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Divorce rate&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Predictions with 90% CI&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_24_0.png" src="_images/bayesian_regression_24_0.png" />
</div>
</div>
<p>We have used the same <code class="docutils literal notranslate"><span class="pre">plot_regression</span></code> function as earlier. We notice that our CI for the predictive distribution is much broader as compared to the last plot due to the additional noise introduced by the <code class="docutils literal notranslate"><span class="pre">sigma</span></code> parameter. Most data points lie well within the 90% CI, which indicates a good fit.</p>
</div>
<div class="section" id="Posterior-Predictive-Density">
<h4>Posterior Predictive Density<a class="headerlink" href="#Posterior-Predictive-Density" title="Permalink to this headline">¶</a></h4>
<p>Likewise, making use of effect-handlers and <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, we can also compute the log likelihood for this model given the dataset, and the log posterior predictive density [<a class="reference external" href="#References">6</a>] which is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split} log \prod_{i=1}^{n} \int p(y_i | \theta) p_{post}(\theta) d\theta
\approx \sum_{i=1}^n log \frac{\sum_s p(\theta^{s})}{S} \\
= \sum_{i=1}^n (log \sum_s p(\theta^{s}) - log(S))\end{split}\]</div>
<p>.</p>
<p>Here, <span class="math notranslate nohighlight">\(i\)</span> indexes the observed data points <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(s\)</span> indexes the posterior samples over the latent parameters <span class="math notranslate nohighlight">\(\theta\)</span>. If the posterior predictive density for a model has a comparatively high value, it indicates that the observed data-points have higher probability under the given model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">model_trace</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">obs_node</span> <span class="o">=</span> <span class="n">model_trace</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obs_node</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">obs_node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">log_pred_density</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">log_lk_fn</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">log_lk_vals</span> <span class="o">=</span> <span class="n">log_lk_fn</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">log_lk_vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Note that NumPyro provides the <a class="reference external" href="http://num.pyro.ai/en/latest/utilities.html#log-likelihood">log_likelihood</a> utility function that can be used directly for computing <code class="docutils literal notranslate"><span class="pre">log</span> <span class="pre">likelihood</span></code> as in the first function for any general model. In this tutorial, we would like to emphasize that there is nothing magical about such utility functions, and you can roll out your own inference utilities using NumPyro’s effect handling stack.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log posterior predictive density: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_pred_density</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span>
                                                                     <span class="n">samples_1</span><span class="p">,</span>
                                                                     <span class="n">model</span><span class="p">,</span>
                                                                     <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                                     <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Log posterior predictive density: -66.65252685546875
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Model-2:-Predictor---Median-Age-of-Marriage">
<h3>Model 2: Predictor - Median Age of Marriage<a class="headerlink" href="#Model-2:-Predictor---Median-Age-of-Marriage" title="Permalink to this headline">¶</a></h3>
<p>We will now model the divorce rate as a function of the median age of marriage. The computations are mostly a reproduction of what we did for Model 1. Notice the following:</p>
<ul class="simple">
<li><p>Divorce rate is inversely related to the age of marriage. Hence states where the median age of marriage is low will likely have a higher divorce rate.</p></li>
<li><p>We get a higher log likelihood as compared to Model 2, indicating that median age of marriage is likely a much better predictor of divorce rate.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>

<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">samples_2</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sample: 100%|██████████| 3000/3000 [00:04&lt;00:00, 690.83it/s, 3 steps of size 7.68e-01. acc. prob=0.92]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
         a     -0.00      0.10     -0.00     -0.16      0.16   1862.10      1.00
        bA     -0.57      0.11     -0.57     -0.75     -0.39   1962.83      1.00
     sigma      0.82      0.08      0.81      0.68      0.95   1544.86      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">posterior_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">samples_2</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">samples_2</span><span class="p">[</span><span class="s1">&#39;bA&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span>
<span class="n">mean_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">posterior_mu</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">hpdi_mu</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">posterior_mu</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_regression</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mean_mu</span><span class="p">,</span> <span class="n">hpdi_mu</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Median marriage age&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Divorce rate&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Regression line with 90% CI&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_31_0.png" src="_images/bayesian_regression_31_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="n">predictions_2</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">samples_2</span><span class="p">)(</span><span class="n">rng_key_</span><span class="p">,</span>
                                             <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span>

<span class="n">mean_pred</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions_2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">hpdi_pred</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">predictions_2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_regression</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mean_pred</span><span class="p">,</span> <span class="n">hpdi_pred</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Median Age&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Divorce rate&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Predictions with 90% CI&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_32_0.png" src="_images/bayesian_regression_32_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log posterior predictive density: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_pred_density</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span>
                                                    <span class="n">samples_2</span><span class="p">,</span>
                                                    <span class="n">model</span><span class="p">,</span>
                                                    <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                    <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Log posterior predictive density: -59.238067626953125
</pre></div></div>
</div>
</div>
<div class="section" id="Model-3:-Predictor---Marriage-Rate-and-Median-Age-of-Marriage">
<h3>Model 3: Predictor - Marriage Rate and Median Age of Marriage<a class="headerlink" href="#Model-3:-Predictor---Marriage-Rate-and-Median-Age-of-Marriage" title="Permalink to this headline">¶</a></h3>
<p>Finally, we will also model divorce rate as depending on both marriage rate as well as the median age of marriage. Note that the model’s posterior predictive density is similar to Model 2 which likely indicates that the marginal information from marriage rate in predicting divorce rate is low when the median age of marriage is already known.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>

<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
         <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">samples_3</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sample: 100%|██████████| 3000/3000 [00:04&lt;00:00, 608.50it/s, 7 steps of size 5.15e-01. acc. prob=0.92]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
         a      0.00      0.10      0.00     -0.17      0.16   1731.49      1.00
        bA     -0.61      0.16     -0.61     -0.88     -0.36   1446.05      1.00
        bM     -0.06      0.16     -0.07     -0.32      0.20   1432.76      1.00
     sigma      0.82      0.08      0.82      0.69      0.96   1654.31      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log posterior predictive density: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">log_pred_density</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span>
                     <span class="n">samples_3</span><span class="p">,</span>
                     <span class="n">model</span><span class="p">,</span>
                     <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                     <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                     <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Log posterior predictive density: -59.06075668334961
</pre></div></div>
</div>
</div>
<div class="section" id="Divorce-Rate-Residuals-by-State">
<h3>Divorce Rate Residuals by State<a class="headerlink" href="#Divorce-Rate-Residuals-by-State" title="Permalink to this headline">¶</a></h3>
<p>The regression plots above shows that the observed divorce rates for many states differs considerably from the mean regression line. To dig deeper into how the last model (Model 3) under-predicts or over-predicts for each of the states, we will plot the posterior predictive and residuals (<code class="docutils literal notranslate"><span class="pre">Observed</span> <span class="pre">divorce</span> <span class="pre">rate</span> <span class="pre">-</span> <span class="pre">Predicted</span> <span class="pre">divorce</span> <span class="pre">rate</span></code>) for each of the states.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Predictions for Model 3.</span>
<span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="n">predictions_3</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">samples_3</span><span class="p">)(</span><span class="n">rng_key_</span><span class="p">,</span>
                                             <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                             <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">pred_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pred_hpdi</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">predictions_3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">residuals_3</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">predictions_3</span>
<span class="n">residuals_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">residuals_hpdi</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">residuals_3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">residuals_mean</span><span class="p">)</span>

<span class="c1"># Plot posterior predictive</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">pred_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">pred_hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">pred_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
               <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
           <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Posterior Predictive (red) vs. Actuals (gray)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span>
          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior Predictive with 90% CI&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">Loc</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>

<span class="c1"># Plot residuals</span>
<span class="n">residuals_3</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">predictions_3</span>
<span class="n">residuals_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals_3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">residuals_hpdi</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">residuals_3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">residuals_hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">residuals_mean</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">residuals_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">err</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
               <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Residuals&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Residuals with 90% CI&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">Loc</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_38_0.png" src="_images/bayesian_regression_38_0.png" />
</div>
</div>
<p>The plot on the left shows the mean predictions with 90% CI for each of the states using Model 3. The gray markers indicate the actual observed divorce rates. The right plot shows the residuals for each of the states, and both these plots are sorted by the residuals, i.e. at the bottom, we are looking at states where the model predictions are higher than the observed rates, whereas at the top, the reverse is true.</p>
<p>Overall, the model fit seems good because most observed data points like within a 90% CI around the mean predictions. However, notice how the model over-predicts by a large margin for states like Idaho (bottom left), and on the other end under-predicts for states like Maine (top right). This is likely indicative of other factors that we are missing out in our model that affect divorce rate across different states. Even ignoring other socio-political variables, one such factor that we have not
yet modeled is the measurement noise given by <code class="docutils literal notranslate"><span class="pre">Divorce</span> <span class="pre">SE</span></code> in the dataset. We will explore this in the next section.</p>
</div>
</div>
<div class="section" id="Regression-Model-with-Measurement-Error">
<h2>Regression Model with Measurement Error<a class="headerlink" href="#Regression-Model-with-Measurement-Error" title="Permalink to this headline">¶</a></h2>
<p>Note that in our previous models, each data point influences the regression line equally. Is this well justified? We will build on the previous model to incorporate measurement error given by <code class="docutils literal notranslate"><span class="pre">Divorce</span> <span class="pre">SE</span></code> variable in the dataset. Incorporating measurement noise will be useful in ensuring that observations that have higher confidence (i.e. lower measurement noise) have a greater impact on the regression line. On the other hand, this will also help us better model outliers with high measurement
errors. For more details on modeling errors due to measurement noise, refer to Chapter 15 of [<a class="reference external" href="#References">1</a>].</p>
<p>To do this, we will reuse Model 3, with the only change that the final observed value has a measurement error given by <code class="docutils literal notranslate"><span class="pre">divorce_sd</span></code> (notice that this has to be standardized since the <code class="docutils literal notranslate"><span class="pre">divorce</span></code> variable itself has been standardized to mean 0 and std 1).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">model_se</span><span class="p">(</span><span class="n">marriage</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">divorce_sd</span><span class="p">,</span> <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">bM</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;bM&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">bM</span> <span class="o">*</span> <span class="n">marriage</span>
    <span class="n">bA</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;bA&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">bA</span> <span class="o">*</span> <span class="n">age</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">M</span> <span class="o">+</span> <span class="n">A</span>
    <span class="n">divorce_rate</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;divorce_rate&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">divorce_rate</span><span class="p">,</span> <span class="n">divorce_sd</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Standardize</span>
<span class="n">dset</span><span class="p">[</span><span class="s1">&#39;DivorceScaledSD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;Divorce SE&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>

<span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">model_se</span><span class="p">,</span> <span class="n">target_accept_prob</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key_</span><span class="p">,</span> <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
         <span class="n">divorce_sd</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaledSD</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">divorce</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">samples_4</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sample: 100%|██████████| 4000/4000 [00:06&lt;00:00, 650.76it/s, 15 steps of size 3.00e-01. acc. prob=0.91]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                      mean       std    median      5.0%     95.0%     n_eff     r_hat
               a     -0.06      0.09     -0.06     -0.21      0.10   3381.24      1.00
              bA     -0.61      0.16     -0.61     -0.86     -0.32   2457.71      1.00
              bM      0.06      0.17      0.06     -0.19      0.35   2384.97      1.00
 divorce_rate[0]      1.14      0.37      1.14      0.54      1.74   4196.29      1.00
 divorce_rate[1]      0.69      0.55      0.68     -0.24      1.54   4457.97      1.00
 divorce_rate[2]      0.43      0.34      0.43     -0.12      0.97   4692.82      1.00
 divorce_rate[3]      1.41      0.47      1.41      0.71      2.21   5338.40      1.00
 divorce_rate[4]     -0.90      0.13     -0.90     -1.12     -0.69   6373.86      1.00
 divorce_rate[5]      0.65      0.39      0.64      0.00      1.29   5890.75      1.00
 divorce_rate[6]     -1.36      0.35     -1.35     -1.90     -0.74   6029.70      1.00
 divorce_rate[7]     -0.33      0.48     -0.32     -1.13      0.42   6226.93      1.00
 divorce_rate[8]     -1.88      0.61     -1.89     -2.84     -0.86   3797.97      1.00
 divorce_rate[9]     -0.62      0.16     -0.62     -0.88     -0.33   7313.05      1.00
divorce_rate[10]      0.76      0.28      0.75      0.31      1.24   5122.44      1.00
divorce_rate[11]     -0.54      0.47     -0.55     -1.32      0.22   4301.37      1.00
divorce_rate[12]      0.20      0.51      0.21     -0.60      1.07   2646.56      1.00
divorce_rate[13]     -0.87      0.23     -0.86     -1.24     -0.49   6676.11      1.00
divorce_rate[14]      0.55      0.31      0.55      0.04      1.03   5340.67      1.00
divorce_rate[15]      0.29      0.38      0.29     -0.35      0.89   7546.96      1.00
divorce_rate[16]      0.51      0.43      0.50     -0.23      1.17   4965.65      1.00
divorce_rate[17]      1.24      0.34      1.25      0.69      1.82   4936.42      1.00
divorce_rate[18]      0.42      0.38      0.42     -0.15      1.11   5954.93      1.00
divorce_rate[19]      0.38      0.56      0.37     -0.53      1.28   2854.65      1.00
divorce_rate[20]     -0.56      0.32     -0.55     -1.09     -0.05   5861.17      1.00
divorce_rate[21]     -1.10      0.26     -1.10     -1.53     -0.66   5929.05      1.00
divorce_rate[22]     -0.28      0.27     -0.28     -0.70      0.16   6215.17      1.00
divorce_rate[23]     -0.99      0.30     -1.00     -1.44     -0.45   4756.94      1.00
divorce_rate[24]      0.42      0.42      0.41     -0.25      1.10   6284.63      1.00
divorce_rate[25]     -0.03      0.32     -0.03     -0.53      0.53   6587.60      1.00
divorce_rate[26]     -0.02      0.50     -0.02     -0.88      0.75   5119.31      1.00
divorce_rate[27]     -0.15      0.38     -0.14     -0.78      0.44   4868.48      1.00
divorce_rate[28]     -0.26      0.50     -0.27     -1.06      0.61   4898.44      1.00
divorce_rate[29]     -1.79      0.24     -1.80     -2.19     -1.40   5940.81      1.00
divorce_rate[30]      0.18      0.43      0.17     -0.60      0.80   6070.03      1.00
divorce_rate[31]     -1.66      0.16     -1.66     -1.92     -1.38   7048.38      1.00
divorce_rate[32]      0.12      0.24      0.11     -0.24      0.52   6550.93      1.00
divorce_rate[33]     -0.03      0.53     -0.01     -0.92      0.81   4108.95      1.00
divorce_rate[34]     -0.13      0.22     -0.13     -0.51      0.21   7752.43      1.00
divorce_rate[35]      1.27      0.40      1.27      0.66      1.99   5621.12      1.00
divorce_rate[36]      0.23      0.36      0.22     -0.36      0.81   7705.96      1.00
divorce_rate[37]     -1.02      0.22     -1.02     -1.40     -0.68   5115.13      1.00
divorce_rate[38]     -0.93      0.54     -0.93     -1.84     -0.10   3426.71      1.00
divorce_rate[39]     -0.67      0.32     -0.67     -1.23     -0.17   6310.21      1.00
divorce_rate[40]      0.25      0.54      0.25     -0.60      1.15   4844.06      1.00
divorce_rate[41]      0.73      0.35      0.74      0.12      1.27   5814.62      1.00
divorce_rate[42]      0.20      0.18      0.20     -0.12      0.48   8983.24      1.00
divorce_rate[43]      0.82      0.42      0.84      0.13      1.52   3795.81      1.00
divorce_rate[44]     -0.42      0.52     -0.43     -1.25      0.48   4979.32      1.00
divorce_rate[45]     -0.38      0.25     -0.38     -0.80      0.02   6811.34      1.00
divorce_rate[46]      0.13      0.31      0.14     -0.38      0.64   6527.01      1.00
divorce_rate[47]      0.57      0.48      0.56     -0.22      1.33   6760.92      1.00
divorce_rate[48]     -0.63      0.27     -0.63     -1.08     -0.20   6560.02      1.00
divorce_rate[49]      0.86      0.59      0.87     -0.13      1.78   4066.94      1.00
           sigma      0.58      0.11      0.57      0.41      0.76   1067.58      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="section" id="Effect-of-Incorporating-Measurement-Noise-on-Residuals">
<h3>Effect of Incorporating Measurement Noise on Residuals<a class="headerlink" href="#Effect-of-Incorporating-Measurement-Noise-on-Residuals" title="Permalink to this headline">¶</a></h3>
<p>Notice that our values for the regression coefficients is very similar to Model 3. However, introducing measurement noise allows us to more closely match our predictive distribution to the observed values. We can see this if we plot the residuals as earlier.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key_</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="n">predictions_4</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model_se</span><span class="p">,</span> <span class="n">samples_4</span><span class="p">)(</span><span class="n">rng_key_</span><span class="p">,</span>
                                                <span class="n">marriage</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">MarriageScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                <span class="n">age</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">AgeScaled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                <span class="n">divorce_sd</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaledSD</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sd</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaledSD</span><span class="o">.</span><span class="n">values</span>
<span class="n">residuals_4</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">predictions_4</span>
<span class="n">residuals_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals_4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">residuals_hpdi</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">residuals_4</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">residuals_hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">residuals_mean</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">residuals_mean</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>


<span class="c1"># Plot Residuals</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">residuals_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">err</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># Plot SD</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">residuals_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">sd</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="c1"># Plot earlier mean residual</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaled</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">predictions_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span>
        <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Residuals&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Residuals with 90% CI&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">Loc</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">2.8</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;Residuals (with error-bars) from current model (in red). &#39;</span>
                  <span class="s1">&#39;Black marker </span><span class="se">\n</span><span class="s1">shows residuals from the previous model (Model 3). &#39;</span>
                  <span class="s1">&#39;Measurement </span><span class="se">\n</span><span class="s1">error is indicated by orange bar.&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_46_0.png" src="_images/bayesian_regression_46_0.png" />
</div>
</div>
<p>The plot above shows the residuals for each of the states, along with the measurement noise given by inner error bar. The gray dots are the mean residuals from our earlier Model 3. Notice how having an additional degree of freedom to model the measurement noise has shrunk the residuals. In particular, for Idaho and Maine, our predictions are now much closer to the observed values after incorporating measurement noise in the model.</p>
<p>To better see how measurement noise affects the movement of the regression line, let us plot the residuals with respect to the measurement noise.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">DivorceScaledSD</span><span class="o">.</span><span class="n">values</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Measurement Noise&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean residuals (Model 4: red, Model 3: blue)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/bayesian_regression_48_0.png" src="_images/bayesian_regression_48_0.png" />
</div>
</div>
<p>The plot above shows what has happend in more detail - the regression line itself has moved to ensure a better fit for observations with low measurement noise (left of the plot) where the residuals have shrunk very close to 0. That is to say that data points with low measurement error have a concomitantly higher contribution in determining the regression line. On the other hand, for states with high measurement error (right of the plot), incorporating measurement noise allows us to move our
posterior distribution mass closer to the observations resulting in a shrinkage of residuals as well.</p>
</div>
</div>
<div class="section" id="References">
<h2>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>McElreath, R. (2016). Statistical Rethinking: A Bayesian Course with Examples in R and Stan CRC Press.</p></li>
<li><p>Stan Development Team. <a class="reference external" href="https://mc-stan.org/docs/2_19/stan-users-guide/index.html">Stan User’s Guide</a></p></li>
<li><p>Goodman, N.D., and StuhlMueller, A. (2014). <a class="reference external" href="http://dippl.org/">The Design and Implementation of Probabilistic Programming Languages</a></p></li>
<li><p>Pyro Development Team. <a class="reference external" href="http://pyro.ai/examples/effect_handlers.html">Poutine: A Guide to Programming with Effect Handlers in Pyro</a></p></li>
<li><p>Hoffman, M.D., Gelman, A. (2011). The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo.</p></li>
<li><p>Betancourt, M. (2017). A Conceptual Introduction to Hamiltonian Monte Carlo.</p></li>
<li><p>JAX Development Team (2018). <a class="reference external" href="https://github.com/google/jax">Composable transformations of Python+NumPy programs: differentiate, vectorize, JIT to GPU/TPU, and more</a></p></li>
<li><p>Gelman, A., Hwang, J., and Vehtari A. <a class="reference external" href="https://arxiv.org/pdf/1307.5928.pdf">Understanding predictive information criteria for Bayesian models</a></p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="time_series_forecasting.html" class="btn btn-neutral float-right" title="Time Series Forecasting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to NumPyro Examples and Tutorials!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Uber Technologies, Inc

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>