

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Enumerate Hidden Markov Model &mdash; NumPyro Tutorials 0.3.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/pyro.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Proportion Test" href="proportion_test.html" />
    <link rel="prev" title="Bayesian Models of Annotation" href="annotation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> NumPyro Tutorials
          

          
            
            <img src="../_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bayesian_regression.html">Bayesian Regression Using NumPyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../time_series_forecasting.html">Time Series Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bayesian_imputation.html">Bayesian Imputation</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Code Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="baseball.html">Baseball</a></li>
<li class="toctree-l2"><a class="reference internal" href="bnn.html">Bayesian Neural Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="funnel.html">Neal’s Funnel</a></li>
<li class="toctree-l2"><a class="reference internal" href="gp.html">Gaussian Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="ucbadmit.html">Generalized Linear Mixed Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="hmm.html">Hidden Markov Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="neutra.html">Neural Transport</a></li>
<li class="toctree-l2"><a class="reference internal" href="ode.html">Predator-Prey Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="sparse_regression.html">Sparse Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="stochastic_volatility.html">Stochastic Volatility</a></li>
<li class="toctree-l2"><a class="reference internal" href="vae.html">Variational Autoencoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="annotation.html">Bayesian Models of Annotation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Enumerate Hidden Markov Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="proportion_test.html">Proportion Test</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NumPyro Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Code Examples</a> &raquo;</li>
        
      <li>Enumerate Hidden Markov Model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/examples/hmm_enum.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-examples-hmm-enum-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="enumerate-hidden-markov-model">
<span id="sphx-glr-examples-hmm-enum-py"></span><h1>Enumerate Hidden Markov Model<a class="headerlink" href="#enumerate-hidden-markov-model" title="Permalink to this headline">¶</a></h1>
<p>This example is ported from [1], which shows how to marginalize out
discrete model variables in Pyro.</p>
<p>This combines MCMC with a variable elimination algorithm, where we
use enumeration to exactly marginalize out some variables from the
joint density.</p>
<p>To marginalize out discrete variables <code class="docutils literal notranslate"><span class="pre">x</span></code>:</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Verify that the variable dependency structure in your model</dt><dd><p>admits tractable inference, i.e. the dependency graph among
enumerated variables should have narrow treewidth.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Ensure your model can handle broadcasting of the sample values</dt><dd><p>of those variables</p>
</dd>
</dl>
</li>
</ol>
<p>Note that difference from [1], which uses Python loop, here we use
<code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code> to reduce compilation
times (only one step needs to be compiled) of the model. Under the
hood, <cite>scan</cite> stacks all the priors’ parameters and values into
an additional time dimension. This allows us computing the joint
density in parallel. In addition, the stacked form allows us
to use the parallel-scan algorithm in [2], which reduces parallel
complexity from O(length) to O(log(length)).</p>
<p>Data are taken from [3]. However, the original source of the data
seems to be the Institut fuer Algorithmen und Kognitive Systeme
at Universitaet Karlsruhe.</p>
<p><strong>References:</strong></p>
<blockquote>
<div><ol class="arabic simple">
<li><p><em>Pyro’s Hidden Markov Model example</em>,
(<a class="reference external" href="https://pyro.ai/examples/hmm.html">https://pyro.ai/examples/hmm.html</a>)</p></li>
<li><p><em>Temporal Parallelization of Bayesian Smoothers</em>,
Simo Sarkka, Angel F. Garcia-Fernandez
(<a class="reference external" href="https://arxiv.org/abs/1905.13002">https://arxiv.org/abs/1905.13002</a>)</p></li>
<li><p><em>Modeling Temporal Dependencies in High-Dimensional Sequences:
Application to Polyphonic Music Generation and Transcription</em>,
Boulanger-Lewandowski, N., Bengio, Y. and Vincent, P.</p></li>
</ol>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">from</span> <span class="nn">numpyro.contrib.control_flow</span> <span class="kn">import</span> <span class="n">scan</span>
<span class="kn">from</span> <span class="nn">numpyro.contrib.indexing</span> <span class="kn">import</span> <span class="n">Vindex</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.examples.datasets</span> <span class="kn">import</span> <span class="n">JSB_CHORALES</span><span class="p">,</span> <span class="n">load_dataset</span>
<span class="kn">from</span> <span class="nn">numpyro.handlers</span> <span class="kn">import</span> <span class="n">mask</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">HMC</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<span class="c1"># Let&#39;s start with a simple Hidden Markov Model.</span>
<span class="c1">#</span>
<span class="c1">#     x[t-1] --&gt; x[t] --&gt; x[t+1]</span>
<span class="c1">#        |        |         |</span>
<span class="c1">#        V        V         V</span>
<span class="c1">#     y[t-1]     y[t]     y[t+1]</span>
<span class="c1">#</span>
<span class="c1"># This model includes a plate for the data_dim = 44 keys on the piano. This</span>
<span class="c1"># model has two &quot;style&quot; parameters probs_x and probs_y that we&#39;ll draw from a</span>
<span class="c1"># prior. The latent state is x, and the observed state is y.</span>
<span class="k">def</span> <span class="nf">model_1</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">include_prior</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">num_sequences</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">data_dim</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">include_prior</span><span class="p">):</span>
        <span class="n">probs_x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_x&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">probs_y</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_y&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">])</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transition_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">x_prev</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;sequences&quot;</span><span class="p">,</span> <span class="n">num_sequences</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">lengths</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs_x</span><span class="p">[</span><span class="n">x_prev</span><span class="p">]))</span>
                <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tones&quot;</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs_y</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span>

    <span class="n">x_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="c1"># NB swapaxes: we move time dimension of `sequences` to the front to scan over it</span>
    <span class="n">scan</span><span class="p">(</span><span class="n">transition_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


<span class="c1"># Next let&#39;s add a dependency of y[t] on y[t-1].</span>
<span class="c1">#</span>
<span class="c1">#     x[t-1] --&gt; x[t] --&gt; x[t+1]</span>
<span class="c1">#        |        |         |</span>
<span class="c1">#        V        V         V</span>
<span class="c1">#     y[t-1] --&gt; y[t] --&gt; y[t+1]</span>
<span class="k">def</span> <span class="nf">model_2</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">include_prior</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">num_sequences</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">data_dim</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">include_prior</span><span class="p">):</span>
        <span class="n">probs_x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_x&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">probs_y</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_y&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">])</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transition_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">x_prev</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;sequences&quot;</span><span class="p">,</span> <span class="n">num_sequences</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">lengths</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs_x</span><span class="p">[</span><span class="n">x_prev</span><span class="p">]))</span>
                <span class="c1"># Note the broadcasting tricks here: to index probs_y on tensors x and y,</span>
                <span class="c1"># we also need a final tensor for the tones dimension. This is conveniently</span>
                <span class="c1"># provided by the plate associated with that dimension.</span>
                <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tones&quot;</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">tones</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                       <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs_y</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">,</span> <span class="n">tones</span><span class="p">]),</span>
                                       <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span>

    <span class="n">x_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">y_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">scan</span><span class="p">(</span><span class="n">transition_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="n">y_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


<span class="c1"># Next consider a Factorial HMM with two hidden states.</span>
<span class="c1">#</span>
<span class="c1">#    w[t-1] ----&gt; w[t] ---&gt; w[t+1]</span>
<span class="c1">#        \ x[t-1] --\-&gt; x[t] --\-&gt; x[t+1]</span>
<span class="c1">#         \  /       \  /       \  /</span>
<span class="c1">#          \/         \/         \/</span>
<span class="c1">#        y[t-1]      y[t]      y[t+1]</span>
<span class="c1">#</span>
<span class="c1"># Note that since the joint distribution of each y[t] depends on two variables,</span>
<span class="c1"># those two variables become dependent. Therefore during enumeration, the</span>
<span class="c1"># entire joint space of these variables w[t],x[t] needs to be enumerated.</span>
<span class="c1"># For that reason, we set the dimension of each to the square root of the</span>
<span class="c1"># target hidden dimension.</span>
<span class="k">def</span> <span class="nf">model_3</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">include_prior</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">num_sequences</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">data_dim</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">hidden_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># split between w and x</span>
    <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">include_prior</span><span class="p">):</span>
        <span class="n">probs_w</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_w&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">probs_x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_x&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">probs_y</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_y&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">])</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transition_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">w_prev</span><span class="p">,</span> <span class="n">x_prev</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;sequences&quot;</span><span class="p">,</span> <span class="n">num_sequences</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">lengths</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs_w</span><span class="p">[</span><span class="n">w_prev</span><span class="p">]))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs_x</span><span class="p">[</span><span class="n">x_prev</span><span class="p">]))</span>
                <span class="c1"># Note the broadcasting tricks here: to index probs_y on tensors x and y,</span>
                <span class="c1"># we also need a final tensor for the tones dimension. This is conveniently</span>
                <span class="c1"># provided by the plate associated with that dimension.</span>
                <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tones&quot;</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">tones</span><span class="p">:</span>
                    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                   <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs_y</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">tones</span><span class="p">]),</span>
                                   <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span>

    <span class="n">w_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">x_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">scan</span><span class="p">(</span><span class="n">transition_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">w_init</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


<span class="c1"># By adding a dependency of x on w, we generalize to a</span>
<span class="c1"># Dynamic Bayesian Network.</span>
<span class="c1">#</span>
<span class="c1">#     w[t-1] ----&gt; w[t] ---&gt; w[t+1]</span>
<span class="c1">#        |  \       |  \       |   \</span>
<span class="c1">#        | x[t-1] ----&gt; x[t] ----&gt; x[t+1]</span>
<span class="c1">#        |   /      |   /      |   /</span>
<span class="c1">#        V  /       V  /       V  /</span>
<span class="c1">#     y[t-1]       y[t]      y[t+1]</span>
<span class="c1">#</span>
<span class="c1"># Note that message passing here has roughly the same cost as with the</span>
<span class="c1"># Factorial HMM, but this model has more parameters.</span>
<span class="k">def</span> <span class="nf">model_4</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">include_prior</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">num_sequences</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">data_dim</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">hidden_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># split between w and x</span>
    <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">include_prior</span><span class="p">):</span>
        <span class="n">probs_w</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_w&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">probs_x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_x&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">expand_by</span><span class="p">([</span><span class="n">hidden_dim</span><span class="p">])</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">probs_y</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;probs_y&quot;</span><span class="p">,</span>
                                 <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                                     <span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">])</span>
                                     <span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transition_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">w_prev</span><span class="p">,</span> <span class="n">x_prev</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;sequences&quot;</span><span class="p">,</span> <span class="n">num_sequences</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">lengths</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs_w</span><span class="p">[</span><span class="n">w_prev</span><span class="p">]))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">Vindex</span><span class="p">(</span><span class="n">probs_x</span><span class="p">)[</span><span class="n">w</span><span class="p">,</span> <span class="n">x_prev</span><span class="p">]))</span>
                <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tones&quot;</span><span class="p">,</span> <span class="n">data_dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">tones</span><span class="p">:</span>
                    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                   <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs_y</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">tones</span><span class="p">]),</span>
                                   <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span>

    <span class="n">w_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">x_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">scan</span><span class="p">(</span><span class="n">transition_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">w_init</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>


<span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;model_&#39;</span><span class="p">):]:</span> <span class="n">model</span>
          <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;model_&#39;</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">JSB_CHORALES</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lengths</span><span class="p">,</span> <span class="n">sequences</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">num_sequences</span><span class="p">:</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">args</span><span class="o">.</span><span class="n">num_sequences</span><span class="p">]</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">args</span><span class="o">.</span><span class="n">num_sequences</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training </span><span class="si">{}</span><span class="s1"> on </span><span class="si">{}</span><span class="s1"> sequences&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)))</span>

    <span class="c1"># find all the notes that are present at least once in the training set</span>
    <span class="n">present_notes</span> <span class="o">=</span> <span class="p">((</span><span class="n">sequences</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># remove notes that are never played (we remove 37/88 notes with default args)</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="n">sequences</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">present_notes</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">truncate</span><span class="p">:</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">truncate</span><span class="p">)</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">sequences</span><span class="p">[:,</span> <span class="p">:</span><span class="n">args</span><span class="o">.</span><span class="n">truncate</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Each sequence has shape </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting inference...&#39;</span><span class="p">)</span>
    <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nuts&#39;</span><span class="p">:</span> <span class="n">NUTS</span><span class="p">,</span> <span class="s1">&#39;hmc&#39;</span><span class="p">:</span> <span class="n">HMC</span><span class="p">}[</span><span class="n">args</span><span class="o">.</span><span class="n">kernel</span><span class="p">](</span><span class="n">model</span><span class="p">)</span>
    <span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_warmup</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_chains</span><span class="p">,</span>
                <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="s2">&quot;NUMPYRO_SPHINXBUILD&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MCMC elapsed time: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;HMC for HMMs&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;one of: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--num-samples&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--hidden-dim&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s2">&quot;--truncate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num-sequences&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--kernel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;nuts&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num-warmup&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num-chains&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use &quot;cpu&quot; or &quot;gpu&quot;.&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">numpyro</span><span class="o">.</span><span class="n">set_platform</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">set_host_device_count</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_chains</span><span class="p">)</span>

    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-hmm-enum-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/d3aa1294c74327f197c81dffc92f599c/hmm_enum.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">hmm_enum.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/cd3deadee0a05d98083401888f54cf12/hmm_enum.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">hmm_enum.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="proportion_test.html" class="btn btn-neutral float-right" title="Proportion Test" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="annotation.html" class="btn btn-neutral float-left" title="Bayesian Models of Annotation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Uber Technologies, Inc

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>